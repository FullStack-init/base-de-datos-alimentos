<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Base de Datos de Alimentos - Control Dietas</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Variables CSS para facilitar la personalización y la gestión del tema (claro/oscuro) */
        :root {
            --background-color: #f8f8f8; /* Gris muy claro para el fondo principal */
            --card-background: #ffffff; /* Blanco puro para las tarjetas de alimentos y modales */
            --text-color: #333333; /* Gris oscuro para el texto principal */
            --light-text-color: #666666; /* Gris medio para texto secundario y etiquetas */
            --primary-color: #007bff; /* Azul estándar y profesional para elementos interactivos y títulos */
            --primary-light: #e0f2ff; /* Azul claro para fondos sutiles y bordes de resaltado */
            --border-color: #e9e9e9; /* Gris claro para bordes de elementos */
            --shadow-color: rgba(0, 0, 0, 0.08); /* Sombra suave para profundidad */
            --modal-backdrop: rgba(0, 0, 0, 0.6); /* Fondo oscuro semitransparente para modales */
            --success-color: #28a745; /* Verde para mensajes de éxito */
            --error-color: #dc3545; /* Rojo para errores y acciones destructivas */
            --progress-bar-bg: #e9ecef; /* Gris claro para el fondo de las barras de progreso */
            --progress-bar-fill-low: #ffc107; /* Amarillo para VDR bajo */
            --progress-bar-fill-medium: #17a2b8; /* Cyan para VDR medio */
            --progress-bar-fill-high: #28a745; /* Verde para VDR alto (ideal) */
            --progress-bar-fill-excess: #dc3545; /* Rojo para VDR en exceso */
        }

        /* Estilos globales del cuerpo */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            justify-content: center; /* Centra el contenido en pantallas grandes */
            min-height: 100vh; /* Ocupa al menos el 100% de la altura de la ventana */
        }

        /* Contenedor principal para limitar el ancho del contenido */
        .container {
            width: 100%; /* Utiliza el ancho completo disponible */
            max-width: 1920px; /* Ancho máximo aumentado para pantallas muy anchas */
            padding: 0 20px; /* Espaciado lateral */
        }

        /* Título principal de la página */
        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 40px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        /* --- Controles y Botones de Acción (Importar/Exportar, Buscar, Ordenar) --- */
        .controls-and-buttons {
            display: flex;
            flex-wrap: wrap; /* Permite que los elementos se envuelvan en pantallas pequeñas */
            justify-content: center;
            align-items: center;
            gap: 15px; /* Espacio entre los elementos */
            margin-bottom: 30px;
            padding: 15px;
            background-color: var(--card-background);
            border-radius: 10px;
            box-shadow: 0 2px 8px var(--shadow-color);
        }

        .action-buttons .btn {
            margin: 0 5px; /* Margen ajustado para los botones de acción */
        }
        .action-buttons input[type="file"] {
            display: none; /* Oculta el input de archivo por defecto */
        }

        /* Contenedores para la búsqueda, ordenación y control de filtros */
        .search-container, .sort-container, .filter-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        /* Estilos para inputs de texto, números y selectores dentro de los controles */
        .search-container input[type="text"],
        .sort-container select,
        .filter-control input[type="number"],
        .filter-control select,
        .detail-quantity-controls select, /* Estilo para nuevo selector de cantidad */
        .detail-quantity-controls input[type="number"] { /* Estilo para nuevo input de cantidad */
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 0.95em;
            color: var(--text-color);
            background-color: var(--background-color);
            min-width: 150px; /* Ancho mínimo para legibilidad */
        }
        /* Efecto de foco para inputs y selects */
        .search-container input:focus,
        .sort-container select:focus,
        .filter-control input:focus,
        .filter-control select:focus,
        .detail-quantity-controls select:focus,
        .detail-quantity-controls input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15); /* Sombra suave al enfocar */
        }
        /* Estilos para las etiquetas de los controles */
        .control-label {
            font-weight: 500;
            color: var(--light-text-color);
            font-size: 0.9em;
            white-space: nowrap; /* Evita que el texto de la etiqueta se rompa */
        }
        
        /* Controles de cantidad en el modal de detalle */
        .detail-quantity-controls {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
            margin-top: -15px;
            margin-bottom: 15px;
        }
        .detail-quantity-controls .control-label {
            margin-right: 5px;
        }
        .detail-quantity-controls select {
            min-width: 120px;
        }
        .detail-quantity-controls input[type="number"] {
            min-width: 80px;
            width: 80px;
        }


        /* --- Sección de Filtros Avanzados --- */
        .advanced-filter-container {
            margin-top: 20px;
            padding: 20px;
            background-color: var(--card-background);
            border-radius: 10px;
            box-shadow: 0 2px 8px var(--shadow-color);
            overflow: hidden; /* Oculta el contenido extra durante la transición */
            transition: max-height 0.4s ease-out, padding 0.4s ease-out, opacity 0.4s ease-out; /* Transiciones suaves */
            max-height: 0; /* Por defecto oculto */
            visibility: hidden; /* Oculta completamente cuando colapsado */
            opacity: 0; /* Desvanece el contenido */
        }

        /* Estado expandido para los filtros avanzados */
        .advanced-filter-container.expanded {
            max-height: 1000px; /* Suficientemente grande para mostrar todo el contenido */
            visibility: visible;
            opacity: 1;
            padding: 20px; /* Asegura que el padding se aplique al expandir */
        }

        /* Botón para alternar la visibilidad de los filtros avanzados */
        .filter-toggle-btn {
            background-color: var(--primary-light);
            color: var(--primary-color);
            border: 1px dashed var(--primary-color);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
            transition: background-color 0.2s ease;
            display: block; /* Elemento de bloque para centrar */
            width: fit-content; /* Ajusta el ancho al contenido */
            margin: 0 auto 20px; /* Centra el botón y añade margen inferior */
        }
        .filter-toggle-btn:hover {
            background-color: #d0e8ff; /* Color de fondo al pasar el ratón */
        }
        
        /* Contenedor de cuadrícula para los grupos de filtros */
        .advanced-filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Columnas responsivas */
            gap: 20px; /* Espacio entre grupos de filtros */
        }
        
        /* Estilos para cada grupo de filtros (ej. Macronutrientes, Características) */
        .filter-group {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            background-color: var(--background-color);
        }

        .filter-group h4 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 15px;
            font-weight: 600;
            font-size: 1.1em;
            border-bottom: 1px dashed var(--border-color);
            padding-bottom: 8px;
        }

        /* Control individual dentro de un grupo de filtros */
        .filter-control {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* Alinea etiquetas e inputs */
            gap: 5px;
        }
        .filter-control label {
            font-size: 0.9em;
            color: var(--light-text-color);
            font-weight: 500;
            margin-bottom: 3px;
        }
        .filter-control input[type="number"] {
            width: calc(100% - 22px); /* Ajusta el ancho por padding y borde */
            min-width: unset; /* Sobrescribe el min-width global para inputs más pequeños */
        }
        .filter-control .checkbox-group {
            display: flex;
            flex-wrap: wrap; /* Permite que los checkboxes se envuelvan */
            gap: 10px 15px; /* Espacio entre checkboxes */
        }
        .filter-control .checkbox-group label {
            display: flex;
            align-items: center;
            font-size: 0.9em;
            color: var(--text-color);
            cursor: pointer;
            gap: 5px;
        }
        .filter-control .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
            transform: scale(1.1); /* Ligeramente más grande para mejor visibilidad */
        }

        /* Acciones de los filtros (ej. Restablecer) */
        .filter-actions {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end; /* Alinea los botones a la derecha */
            gap: 10px;
        }

        /* --- Lista de Alimentos (Diseño de cuadrícula para tarjetas horizontales) --- */
        .food-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(500px, 1fr)); /* Columnas responsivas con min-width de 500px */
            gap: 25px; /* Espacio entre tarjetas */
            padding: 20px 0;
        }

        /* --- Tarjeta de Alimento (Diseño Horizontal) --- */
        .food-card {
            background-color: var(--card-background);
            border-radius: 10px;
            box-shadow: 0 4px 12px var(--shadow-color);
            padding: 20px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 1px solid var(--border-color);
            display: flex; /* Contenedor flex para la estructura interna */
            flex-direction: column; /* Diseño en columna para el encabezado y el contenido */
            align-items: flex-start; /* Alinea los elementos al inicio */
        }

        .food-card:hover {
            transform: translateY(-5px); /* Efecto de elevación al pasar el ratón */
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
        }

        .food-card h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--primary-color); /* Resalta el nombre del producto */
            font-weight: 700;
            font-size: 1.5em; /* Título más grande */
            width: 100%; /* Ancho completo para el encabezado */
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-light); /* Separador visual */
        }

        .food-card-content {
            display: flex; /* Contenedor flex interno para las dos columnas */
            flex-direction: row; /* Elementos internos en horizontal */
            width: 100%;
            gap: 20px; /* Espacio entre las dos columnas */
            flex-grow: 1; /* Permite que el contenido se expanda */
        }

        .food-card .left-column {
            flex: 1; /* Ocupa el espacio disponible */
            min-width: 220px; /* Ancho mínimo para legibilidad */
            display: flex;
            flex-direction: column;
        }

        .food-card .right-column {
            flex: 1; /* Ocupa el espacio disponible */
            min-width: 220px; /* Ancho mínimo para legibilidad */
            display: flex;
            flex-direction: column;
            border-left: 1px dashed var(--border-color); /* Separador visual */
            padding-left: 20px;
            align-self: stretch; /* Se estira para llenar la altura */
        }

        .food-card p {
            margin: 3px 0;
            font-size: 0.95em;
            color: var(--light-text-color);
            word-wrap: break-word; /* Permite que las palabras largas se rompan */
            overflow-wrap: break-word; /* Asegura el salto de palabras completo */
        }

        .food-card p strong {
            color: var(--text-color);
        }

        .food-card .nutrition-summary {
            margin-top: 5px;
            flex-grow: 1; /* Permite que crezca y empuje el precio hacia abajo */
        }
        
        .food-card .nutrition-summary p.sub-nutrient {
            margin-left: 15px; /* Sangría para sub-nutrientes */
            font-size: 0.9em;
            color: var(--light-text-color);
        }

        .food-card .micronutrients-brief {
            font-size: 0.9em;
            color: var(--light-text-color);
            margin-top: 0;
            padding-top: 0;
            flex-grow: 1;
        }

        .food-card .micronutrients-brief strong {
            display: block;
            margin-bottom: 8px;
            color: var(--text-color);
            font-size: 1em;
            border-bottom: 1px dashed var(--primary-light);
            padding-bottom: 5px;
        }
        .food-card .micronutrients-brief ul {
            list-style: none; /* Elimina los puntos de lista */
            padding: 0;
            margin: 0;
        }
        .food-card .micronutrients-brief li {
            margin-bottom: 5px;
            font-size: 0.9em;
            color: var(--light-text-color);
        }

        .food-card .price {
            font-size: 1.05em;
            font-weight: 600;
            color: var(--primary-color);
            margin-top: auto; /* Empuja el precio al final de su columna */
            text-align: right;
            padding-top: 10px;
            border-top: 1px dashed var(--border-color);
            padding-right: 0;
            padding-bottom: 0;
        }

        /* --- Paginación/Cargar Más --- */
        .load-more-container {
            text-align: center;
            margin-top: 30px;
            margin-bottom: 50px;
        }

        /* --- Estilo de los Modales --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-backdrop);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Asegura que esté sobre otros elementos */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--card-background);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 30px var(--shadow-color);
            width: 90%;
            max-width: 750px; /* Modal más ancho para mejor uso del espacio */
            position: relative;
            transform: translateY(20px); /* Efecto de entrada suave */
            transition: transform 0.3s ease;
            max-height: 90vh; /* Altura máxima del modal */
            overflow-y: auto; /* Permite desplazamiento si el contenido es largo */
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        .modal-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.8em;
            cursor: pointer;
            color: var(--light-text-color);
            transition: color 0.2s;
        }

        .modal-close-btn:hover {
            color: var(--text-color);
        }

        .modal-content h2 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 25px;
            font-weight: 700;
            font-size: 1.8em;
        }

        .modal-content .section-title {
            font-weight: 600;
            color: var(--text-color);
            margin-top: 25px;
            margin-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
            font-size: 1.1em;
        }

        .modal-content p strong {
            color: var(--text-color);
        }

        /* --- Estilo de la Tabla --- */
        .nutrient-table {
            width: 100%;
            border-collapse: collapse; /* Colapsa los bordes de las celdas */
            margin-top: 15px;
            font-size: 0.95em;
        }
        .nutrient-table th, .nutrient-table td {
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            text-align: left;
        }
        .nutrient-table th {
            background-color: var(--primary-light);
            color: var(--primary-color);
            font-weight: 600;
            white-space: nowrap; /* Evita que el texto de los encabezados se envuelva */
        }
        .nutrient-table tbody tr:nth-child(even) {
            background-color: #fcfcfc; /* Rayas de cebra para filas pares */
        }
        .nutrient-table tbody tr:hover {
            background-color: #f5f5f5; /* Efecto de resaltado al pasar el ratón */
        }
        .nutrient-table td:nth-child(2), /* Columna de valor */
        .nutrient-table td:nth-child(3) { /* Columna de %VDR */
            text-align: right;
            font-weight: 500;
            white-space: nowrap; /* Evita que los valores se envuelvan */
        }
        .nutrient-table .sub-nutrient-row td {
            padding-left: 30px; /* Sangría para sub-nutrientes */
            font-size: 0.9em;
            color: var(--light-text-color);
        }
        .nutrient-table .sub-nutrient-row td strong {
            color: var(--text-color);
        }
        .nutrient-table .micronutrient-name {
            font-weight: 500;
            color: var(--text-color);
        }
        .nutrient-table .section-divider td {
            background-color: var(--primary-light);
            color: var(--primary-color);
            font-weight: 600;
            text-align: center;
            border-top: 2px solid var(--primary-color);
            margin-top: 15px;
            padding-top: 15px;
            font-size: 1em;
        }

        /* --- Estilo de la Barra de Progreso VDR --- */
        .vdr-cell {
            display: flex;
            align-items: center;
            justify-content: flex-end; /* Alinea a la derecha para los valores */
            gap: 8px; /* Espacio entre texto y barra */
            min-width: 120px; /* Asegura suficiente espacio para la barra y el texto */
        }

        .vdr-progress-bar {
            width: 80px; /* Ancho fijo para la barra */
            height: 10px;
            background-color: var(--progress-bar-bg);
            border-radius: 5px;
            overflow: hidden;
        }

        .vdr-progress-fill {
            height: 100%;
            border-radius: 5px;
            width: 0%; /* El ancho se establecerá con JS */
            transition: width 0.5s ease-out;
        }

        .vdr-text {
            min-width: 35px; /* Asegura que el texto como "100%" quepa */
            text-align: right;
        }

        /* Colores de la barra de progreso basados en el valor */
        .vdr-progress-fill.low { background-color: var(--progress-bar-fill-low); } /* < 25% */
        .vdr-progress-fill.medium { background-color: var(--progress-bar-fill-medium); } /* 25-75% */
        .vdr-progress-fill.high { background-color: var(--progress-bar-fill-high); } /* 75-100% */
        .vdr-progress-fill.excess { background-color: var(--progress-bar-fill-excess); } /* > 100% */

        /* Acciones de los modales (botones en la parte inferior) */
        .modal-actions {
            margin-top: 35px;
            text-align: right;
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
            display: flex; /* Para alinear los botones */
            justify-content: space-between; /* Espacia el botón de eliminar y los de guardar/cancelar */
            align-items: center;
        }
        .modal-actions .right-actions {
            display: flex;
            gap: 10px;
        }

        /* Estilo general de los botones */
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: background-color 0.2s ease, transform 0.1s ease;
            margin-left: 10px;
            letter-spacing: 0.2px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #0069d9; /* Azul más oscuro al pasar el ratón */
            transform: translateY(-1px);
        }

        .btn-secondary {
            background-color: #f0f0f0;
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background-color: #e0e0e0;
            transform: translateY(-1px);
        }

        .btn-danger {
            background-color: var(--error-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333; /* Rojo más oscuro al pasar el ratón */
            transform: translateY(-1px);
        }

        /* --- Estilo de Formularios --- */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--light-text-color);
            font-size: 0.95em;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group select { /* Aplica estilos también a los selectores */
            width: calc(100% - 24px); /* Considera el padding en el ancho */
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 1em;
            color: var(--text-color);
            background-color: var(--card-background);
            box-sizing: border-box; /* Crucial para que el ancho del select funcione correctamente */
        }
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
        }
        /* Retroalimentación de validación */
        .form-group input.invalid, .form-group select.invalid {
            border-color: var(--error-color);
        }
        .form-group .validation-message {
            color: var(--error-color);
            font-size: 0.85em;
            margin-top: 5px;
            display: none; /* Oculto por defecto */
        }
        .form-group input.invalid + .validation-message,
        .form-group select.invalid + .validation-message {
            display: block; /* Muestra el mensaje si el campo es inválido */
        }

        /* Inputs de Micronutrientes Dinámicos (Modal de Edición) */
        .micronutrient-inputs table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .micronutrient-inputs th, .micronutrient-inputs td {
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            text-align: left;
        }
        .micronutrient-inputs th {
            background-color: var(--primary-light);
            color: var(--primary-color);
            font-weight: 600;
        }
        .micronutrient-inputs td input[type="number"] { /* Específico para input de número */
            width: calc(100% - 70px); /* Ajusta por el selector de unidad y padding */
            box-sizing: border-box; /* Incluye padding/borde en el ancho */
            margin: 0;
            padding: 8px;
            display: inline-block;
            vertical-align: middle;
        }
        .micronutrient-inputs td select.micronutrient-unit-select { /* Específico para selector de unidades */
            width: auto; /* Permite ancho automático basado en el contenido */
            padding: 8px;
            margin-left: 5px;
            display: inline-block; /* Mantiene junto al input */
            vertical-align: middle;
        }
        .micronutrient-inputs .remove-btn {
            background: none;
            border: none;
            color: var(--error-color);
            font-size: 1.5em;
            cursor: pointer;
            padding: 0 5px;
            transition: color 0.2s;
            width: 30px; /* Ancho fijo para la columna del botón */
        }
        .micronutrient-inputs .remove-btn:hover {
            color: #b02a37;
        }
        .add-micronutrient-btn {
            background-color: var(--primary-light);
            color: var(--primary-color);
            border: 1px dashed var(--primary-color);
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
            transition: background-color 0.2s ease;
            margin-top: 15px;
        }
        .add-micronutrient-btn:hover {
            background-color: #d0e8ff;
        }
        .micronutrient-inputs .unit-display {
            display: inline-block;
            margin-left: 5px;
            font-weight: 500;
            color: var(--light-text-color);
        }

        /* Estilos para las notificaciones "toast" */
        .toast-notification {
            visibility: hidden; /* Oculto por defecto */
            min-width: 250px;
            background-color: var(--text-color); /* Fondo oscuro */
            color: #fff; /* Texto blanco */
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 1001; /* Por encima de los modales */
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.5s, visibility 0.5s;
            box-shadow: 0 4px 12px var(--shadow-color);
            font-weight: 500;
        }

        .toast-notification.show {
            visibility: visible;
            opacity: 1;
            animation: fadein 0.5s, fadeout 0.5s 2.5s; /* Animación de entrada y salida */
        }

        /* Keyframe animations para el toast */
        @keyframes fadein {
            from {bottom: 0; opacity: 0;}
            to {bottom: 30px; opacity: 1;}
        }

        @keyframes fadeout {
            from {bottom: 30px; opacity: 1;}
            to {bottom: 0; opacity: 0;}
        }

        /* Dark Mode (opcional, para un ejemplo completo) */
        @media (prefers-color-scheme: dark) {
            :root {
                --background-color: #1e1e1e;
                --card-background: #2b2b2b;
                --text-color: #e0e0e0;
                --light-text-color: #b0b0b0;
                --primary-color: #6daffb; /* Azul más claro para modo oscuro */
                --primary-light: #3a5c7f;
                --border-color: #3e3e3e;
                --shadow-color: rgba(0, 0, 0, 0.3);
                --modal-backdrop: rgba(0, 0, 0, 0.75);
                --progress-bar-bg: #4a4a4a;
                --progress-bar-fill-low: #d4a017;
                --progress-bar-fill-medium: #1f94a7;
                --progress-bar-fill-high: #218838;
                --progress-bar-fill-excess: #a52a2a;
            }
            .food-card h3 { color: var(--primary-color); }
            .food-card p strong { color: var(--text-color); }
            .food-card p, .food-card .micronutrients-brief { color: var(--light-text-color); }
            .food-card .nutrition-summary p.sub-nutrient { color: var(--light-text-color); }
            .modal-content h2, .modal-content .section-title, .filter-group h4 { color: var(--primary-color); }
            .modal-close-btn { color: var(--light-text-color); }
            .btn-secondary { background-color: #3a3a3a; color: var(--text-color); border: 1px solid var(--border-color); }
            .btn-secondary:hover { background-color: #4a4a4a; }
            .form-group label, .filter-control label { color: var(--light-text-color); }
            .form-group input, .form-group select, .filter-control input, .filter-control select, .detail-quantity-controls select, .detail-quantity-controls input {
                background-color: #3a3a3a;
                color: var(--text-color);
                border-color: #4a4a4a;
            }
            .form-group input:focus, .form-group select:focus, .filter-control input:focus, .filter-control select:focus, .detail-quantity-controls select:focus, .detail-quantity-controls input:focus {
                border-color: var(--primary-color);
                box-shadow: 0 0 0 3px rgba(109, 175, 251, 0.15);
            }
            .add-micronutrient-btn, .filter-toggle-btn {
                background-color: var(--primary-light);
                color: var(--primary-color);
                border: 1px dashed var(--primary-color);
            }
            .add-micronutrient-btn:hover, .filter-toggle-btn:hover { background-color: #4a6c90; }
            .nutrient-table th { background-color: var(--primary-light); color: var(--primary-color); }
            .nutrient-table tbody tr:nth-child(even) { background-color: #333333; }
            .nutrient-table tbody tr:hover { background-color: #444444; }
            .nutrient-table .micronutrient-name { color: var(--text-color); }
            .nutrient-table td { color: var(--light-text-color); }
            .nutrient-table td strong { color: var(--text-color); }
            .nutrient-table .section-divider td { background-color: var(--primary-light); color: var(--primary-color); }
            .micronutrient-inputs th, .micronutrient-inputs td { border-color: var(--border-color); }
            .micronutrient-inputs th { background-color: var(--primary-light); color: var(--primary-color); }
            .micronutrient-inputs td input, .micronutrient-inputs td select {
                background-color: #3a3a3a;
                color: var(--text-color);
                border-color: #4a4a4a;
            }
            .micronutrient-inputs .unit-display { color: var(--light-text-color); }
            .filter-group { background-color: #2a2a2a; }
            .toast-notification { background-color: #3a3a3a; color: #e0e0e0; }
        }

        /* Ajustes responsivos */
        @media (max-width: 767px) {
            .food-list {
                grid-template-columns: 1fr; /* Una tarjeta por fila en pantallas pequeñas */
                padding: 10px 0;
            }
            .food-card { padding: 15px; }
            .food-card-content {
                flex-direction: column; /* Apila las columnas verticalmente en pantallas pequeñas */
                gap: 15px;
            }
            .food-card .right-column {
                border-left: none;
                border-top: 1px dashed var(--border-color); /* Borde superior en lugar del izquierdo */
                padding-left: 0;
                padding-top: 15px;
                margin-top: 0;
            }
            .food-card .price {
                text-align: left; /* Alinea el precio a la izquierda en móviles */
                border-top: none;
                padding-top: 0;
            }
            .controls-and-buttons {
                flex-direction: column;
                gap: 10px;
                padding: 10px;
            }
            .controls-and-buttons > div {
                width: 100%; /* Búsqueda/ordenación ocupan el ancho completo */
                justify-content: center;
            }
            .search-container input, .sort-container select {
                width: calc(100% - 20px); /* Ajusta el ancho por el padding interno */
                max-width: none;
                min-width: unset;
            }
            .advanced-filter-grid {
                grid-template-columns: 1fr; /* Apila los grupos de filtros verticalmente */
            }
            .detail-quantity-controls {
                flex-wrap: wrap; /* Permite que los controles se envuelvan */
            }
        }
        /* Media query para pantallas medianas, permite 2 tarjetas con un ancho mínimo decente */
        @media (min-width: 768px) and (max-width: 1259px) { 
            .food-list {
                grid-template-columns: repeat(auto-fill, minmax(450px, 1fr)); /* Ligeramente más pequeño para 2 columnas */
            }
        }

        /* Media query para pantallas grandes, vuelve al min-width de 500px */
        @media (min-width: 1260px) { 
            .food-list {
                grid-template-columns: repeat(auto-fill, minmax(500px, 1fr)); 
            }
        }

    </style>
</head>
<body>

    <div class="container">
        <h1>Base de Datos de Alimentos</h1>

        <div class="controls-and-buttons">
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openEditModal(-1)">+ Añadir Alimento</button>
                <button class="btn btn-secondary" onclick="document.getElementById('importFileInput').click()">Importar Datos</button>
                <input type="file" id="importFileInput" accept=".json" onchange="importData(event)">
                <button class="btn btn-primary" onclick="exportData()">Exportar Datos</button>
            </div>

            <div class="search-container">
                <label for="searchFood" class="control-label">Buscar:</label>
                <input type="text" id="searchFood" placeholder="Buscar alimento..." oninput="filterAndSortFoods()">
            </div>

            <div class="sort-container">
                <label for="sortCriteria" class="control-label">Ordenar por:</label>
                <select id="sortCriteria" onchange="toggleMicronutrientSortSelect(); filterAndSortFoods()">
                    <option value="name">Nombre</option>
                    <option value="calories">Calorías</option>
                    <option value="protein">Proteínas</option>
                    <option value="fat">Grasas</option>
                    <option value="carbs">Carbohidratos</option>
                    <option value="fiber">Fibra</option>
                    <option value="vitamins">Vitaminas</option>
                    <option value="minerals">Minerales</option>
                    <option value="others">Otros</option>
                </select>

                <label for="sortDirection" class="control-label">Dirección:</label>
                <select id="sortDirection" onchange="filterAndSortFoods()">
                    <option value="asc">Ascendente</option>
                    <option value="desc">Descendente</option>
                </select>

                <div id="micronutrientSortContainer" style="display: none;">
                    <label for="sortMicronutrient" class="control-label">Nutriente Específico:</label>
                    <select id="sortMicronutrient" onchange="filterAndSortFoods()">
                        </select>
                </div>
            </div>
        </div>

        <button class="filter-toggle-btn" onclick="toggleAdvancedFilters()">Mostrar Filtros Avanzados</button>

        <div id="advancedFilterContainer" class="advanced-filter-container">
            <div class="advanced-filter-grid">
                <div class="filter-group">
                    <h4>Macronutrientes</h4>
                    <div class="filter-control">
                        <label for="filterCaloriesMin">Calorías (Kcal) Mín:</label>
                        <input type="number" id="filterCaloriesMin" step="1" min="0" oninput="filterAndSortFoods()">
                        <label for="filterCaloriesMax">Calorías (Kcal) Máx:</label>
                        <input type="number" id="filterCaloriesMax" step="1" min="0" oninput="filterAndSortFoods()">
                    </div>
                    <div class="filter-control">
                        <label for="filterProteinMin">Proteínas (g) Mín:</label>
                        <input type="number" id="filterProteinMin" step="0.1" min="0" oninput="filterAndSortFoods()">
                    </div>
                    <div class="filter-control">
                        <label for="filterFatMax">Grasas (g) Máx:</label>
                        <input type="number" id="filterFatMax" step="0.1" min="0" oninput="filterAndSortFoods()">
                    </div>
                    <div class="filter-control">
                        <label for="filterCarbsMin">Carbohidratos (g) Mín:</label>
                        <input type="number" id="filterCarbsMin" step="0.1" min="0" oninput="filterAndSortFoods()">
                    </div>
                    <div class="filter-control">
                        <label for="filterFiberMin">Fibra (g) Mín:</label>
                        <input type="number" id="filterFiberMin" step="0.1" min="0" oninput="filterAndSortFoods()">
                    </div>
                    <div class="filter-control">
                        <label for="filterSugarMax">Azúcares (g) Máx:</label>
                        <input type="number" id="filterSugarMax" step="0.1" min="0" oninput="filterAndSortFoods()">
                    </div>
                    <div class="filter-control">
                        <label for="filterSaltMax">Sal (g) Máx:</label>
                        <input type="number" id="filterSaltMax" step="0.01" min="0" oninput="filterAndSortFoods()">
                    </div>
                </div>

                <div class="filter-group">
                    <h4>Características Especiales</h4>
                    <div class="filter-control checkbox-group" id="filterSpecialCharacteristics">
                        </div>
                </div>

                <div class="filter-group">
                    <h4>Otros Filtros</h4>
                    <div class="filter-control">
                        <label for="filterPriceMax">Precio (€/kg o €/L) Máx:</label>
                        <input type="number" id="filterPriceMax" step="0.01" min="0" oninput="filterAndSortFoods()">
                    </div>
                    <div class="filter-control">
                        <label for="filterCategory">Categoría:</label>
                        <select id="filterCategory" onchange="filterAndSortFoods()">
                            <option value="">Todas</option>
                            </select>
                    </div>
                </div>
            </div>
            <div class="filter-actions">
                <button class="btn btn-secondary" onclick="resetAdvancedFilters()">Restablecer Filtros</button>
            </div>
        </div>

        <div class="food-list" id="foodList">
            </div>

        <div class="load-more-container">
            <button class="btn btn-secondary" id="loadMoreBtn" style="display: none;" onclick="loadMoreFoods()">Cargar Más Alimentos</button>
        </div>
    </div>

    <div id="foodDetailModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeModal('foodDetailModal')">&times;</button>
            <h2 id="detailFoodName"></h2>
            
            <div class="detail-quantity-controls">
                <span class="control-label">Valores por:</span>
                <select id="detailQuantitySelector" onchange="updateDetailNutrients()">
                    <option value="100">100</option>
                    <option value="200">200</option>
                    <option value="user">Personalizado</option>
                </select>
                <input type="number" id="detailCustomQuantity" step="1" min="1" value="100" style="display: none;" oninput="updateDetailNutrients()">
                <span class="control-label" id="detailUnitLabel">g</span>
            </div>

            <p class="section-title">Información General:</p>
            <p><strong>Categoría:</strong> <span id="detailCategory"></span></p>
            <p><strong>Características:</strong> <span id="detailCharacteristics"></span></p>
            <p><strong>Precio:</strong> <span id="detailPrice"></span></p>

            <p class="section-title">Información Nutricional:</p>
            <table class="nutrient-table">
                <thead>
                    <tr>
                        <th>Nutriente</th>
                        <th>Cantidad</th>
                        <th>% VDR</th>
                    </tr>
                </thead>
                <tbody id="detailNutrientTableBody">
                    </tbody>
            </table>

            <div class="modal-actions">
                <button class="btn btn-danger" onclick="confirmDeleteFood()">Eliminar Alimento</button>
                <div class="right-actions">
                    <button class="btn btn-secondary" onclick="openEditModalFromDetail()">Editar Alimento</button>
                    <button class="btn btn-primary" onclick="closeModal('foodDetailModal')">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="foodEditModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeModal('foodEditModal')">&times;</button>
            <h2>Editar Alimento: <span id="editFoodNameHeader"></span></h2>
            <p style="text-align: right; color: var(--light-text-color); margin-top: -15px;">Valores por 100<span id="editUnitLabel">g</span></p>

            <form id="editFoodForm">
                <input type="hidden" id="editFoodIndex">

                <div class="form-group">
                    <label for="editName">Nombre del Alimento:</label>
                    <input type="text" id="editName" required>
                    <span class="validation-message"></span>
                </div>
                
                <div class="form-group">
                    <label for="editCategory">Categoría:</label>
                    <select id="editCategory" required>
                        </select>
                    <span class="validation-message"></span>
                </div>

                <div class="form-group">
                    <label for="editUnitBase">Unidad Base (para 100g/ml):</label>
                    <select id="editUnitBase" required onchange="updatePriceInput(this.value)">
                        <option value="g">Gramo (g)</option>
                        <option value="ml">Mililitro (ml)</option>
                    </select>
                    <span class="validation-message"></span>
                </div>

                <div class="form-group">
                    <label for="editPrice">Precio por <span id="priceUnitLabel">kg</span>:</label>
                    <input type="number" id="editPrice" step="0.01" min="0" required>
                    <span class="validation-message"></span>
                </div>

                <p class="section-title">Características Especiales:</p>
                <div class="form-group checkbox-group" id="editCharacteristics">
                    </div>

                <p class="section-title">Macronutrientes:</p>
                <div class="form-group">
                    <label for="editCalories">Calorías (Kcal):</label>
                    <input type="number" id="editCalories" step="0.1" min="0" required readonly> 
                    <span class="validation-message"></span>
                </div>
                <div class="form-group">
                    <label for="editProtein">Proteínas (g):</label>
                    <input type="number" id="editProtein" step="0.1" min="0" required oninput="calculateAndDisplayCalories(); validateMacronutrients()">
                    <span class="validation-message"></span>
                </div>
                <div class="form-group">
                    <label for="editCarbs">Carbohidratos (g):</label>
                    <input type="number" id="editCarbs" step="0.1" min="0" required oninput="calculateAndDisplayCalories(); validateMacronutrients()">
                    <span class="validation-message"></span>
                </div>
                <div class="form-group">
                    <label for="editSugars">de los cuales Azúcares (g):</label>
                    <input type="number" id="editSugars" step="0.1" min="0" oninput="validateMacronutrients()">
                    <span class="validation-message"></span>
                </div>
                <div class="form-group">
                    <label for="editFat">Grasas (g):</label>
                    <input type="number" id="editFat" step="0.1" min="0" required oninput="calculateAndDisplayCalories(); validateMacronutrients()">
                    <span class="validation-message"></span>
                </div>
                <div class="form-group">
                    <label for="editSaturatedFat">de las cuales Grasas Saturadas (g):</label>
                    <input type="number" id="editSaturatedFat" step="0.1" min="0" oninput="validateMacronutrients()">
                    <span class="validation-message"></span>
                </div>
                <div class="form-group">
                    <label for="editFiber">Fibra (g):</label>
                    <input type="number" id="editFiber" step="0.1" min="0" oninput="calculateAndDisplayCalories()">
                    <span class="validation-message"></span>
                </div>
                <div class="form-group">
                    <label for="editSalt">Sal (g):</label>
                    <input type="number" id="editSalt" step="0.01" min="0">
                    <span class="validation-message"></span>
                </div>

                <p class="section-title">Vitaminas y Minerales:</p>
                <div class="micronutrient-inputs">
                    <table id="editMicronutrientTable">
                        <thead>
                            <tr>
                                <th>Nutriente</th>
                                <th>Cantidad y Unidad</th>
                                <th></th> </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
                <button type="button" class="add-micronutrient-btn" onclick="addMicronutrientField()">+ Añadir Vitamina/Mineral</button>

                <div class="modal-actions">
                    <button class="btn btn-danger" id="deleteFoodBtn" style="display: none;" onclick="confirmDeleteFood()">Eliminar Alimento</button>
                    <div class="right-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('foodEditModal')">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="confirmationModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <h2>Confirmar Acción</h2>
            <p id="confirmationMessage"></p>
            <div class="modal-actions" style="justify-content: center;">
                <button class="btn btn-secondary" onclick="closeModal('confirmationModal')">Cancelar</button>
                <button class="btn btn-danger" id="confirmActionButton">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="toastNotification" class="toast-notification"></div>

    <script>
        // L_E_O: Almacenamiento de Datos y Configuración Inicial
        // Array principal que contendrá todos los datos de los alimentos.
        // Ahora se inicializa vacío y se cargará desde el JSON.
        let foodData = [];

        // L_E_O: Categorías de alimentos para filtrado y clasificación.
        const foodCategories = [
            "Frutas", "Verduras y Hortalizas", "Carnes y Proteínas", "Lácteos y Alternativas",
            "Pan, Cereales y Legumbres", "Frutos Secos y Semillas", "Grasas Saludables",
            "Bebidas", "Hierbas y Condimentos", "Otros"
        ];

        // L_E_O: Características especiales para filtrado y etiquetado.
        const specialCharacteristics = [
            "Apto Vegano", "Apto Celíaco", "Bajo en Sal", "Sin Lactosa", "Alto en Fibra",
            "Bajo en Grasa", "Rico en Omega-3", "Fuente de Calcio", "Probiótico",
            "Sin Gluten", "Alto en Proteínas", "Alto en Vitamina C", "Alto en Hierro",
            "Rico en Vitamina E", "Alto en Vitamina K", "Bajo en Azúcares", "Sin Calorías",
            "Fuente de Vitamina D"
        ];

        // L_E_O: Lista predefinida de micronutrientes disponibles para añadir.
        const availableMicronutrients = [
            { name: "Vitamina A", unit: "mcg", type: "Vitamina" }, { name: "Vitamina B1", unit: "mg", type: "Vitamina" },
            { name: "Vitamina B2", unit: "mg", type: "Vitamina" }, { name: "Vitamina B3", unit: "mg", type: "Vitamina" },
            { name: "Vitamina B5", unit: "mg", type: "Vitamina" }, { name: "Vitamina B6", unit: "mg", type: "Vitamina" },
            { name: "Vitamina B9 (Folato)", unit: "mcg", type: "Vitamina" }, { name: "Vitamina B12", unit: "mcg", type: "Vitamina" },
            { name: "Vitamina C", unit: "mg", type: "Vitamina" }, { name: "Vitamina D", unit: "mcg", type: "Vitamina" },
            { name: "Vitamina E", unit: "mg", type: "Vitamina" }, { name: "Vitamina K1", unit: "mcg", type: "Vitamina" },
            { name: "Vitamina K2", unit: "mcg", type: "Vitamina" }, { name: "Biotina", unit: "mcg", type: "Vitamina" },
            { name: "Colina", unit: "mg", type: "Vitamina" }, { name: "Calcio", unit: "mg", type: "Mineral" },
            { name: "Cloro", unit: "mg", type: "Mineral" }, { name: "Cobre", unit: "mg", type: "Mineral" },
            { name: "Cromo", unit: "mcg", type: "Mineral" }, { name: "Fósforo", unit: "mg", type: "Mineral" },
            { name: "Hierro", unit: "mg", type: "Mineral" }, { name: "Magnesio", unit: "mg", type: "Mineral" },
            { name: "Manganeso", unit: "mg", type: "Mineral" }, { name: "Molibdeno", unit: "mcg", type: "Mineral" },
            { name: "Potasio", unit: "mg", "type": "Mineral" }, { name: "Selenio", unit: "mcg", type: "Mineral" },
            { name: "Sodio", unit: "g", type: "Mineral" }, { name: "Yodo", unit: "mcg", type: "Mineral" },
            { name: "Zinc", unit: "mg", type: "Mineral" }, { name: "Omega-3", unit: "g", type: "Otros" },
            { name: "Omega-6", unit: "g", type: "Otros" }, { name: "Omega-9 (Ácido Oleico)", unit: "g", type: "Otros" }
        ];

        // L_E_O: Valores Diarios Recomendados (VDR) - EJEMPLO.
        const dailyRecommendedValues = {
            "calories": 2000, "fat": 70, "saturatedFat": 20, "carbs": 275, "sugars": 50, "protein": 50, "fiber": 30, "salt": 6,
            "Vitamina A": { value: 800, unit: "mcg" }, "Vitamina C": { value: 80, unit: "mg" }, "Vitamina D": { value: 5, unit: "mcg" },
            "Vitamina E": { value: 12, unit: "mg" }, "Vitamina K1": { value: 75, unit: "mcg" }, "Vitamina K2": { value: 45, unit: "mcg" },
            "Vitamina B1": { value: 1.1, unit: "mg" }, "Vitamina B2": { value: 1.4, unit: "mg" }, "Vitamina B3": { value: 16, unit: "mg" },
            "Vitamina B5": { value: 6, unit: "mg" }, "Vitamina B6": { value: 1.4, unit: "mg" }, "Vitamina B9 (Folato)": { value: 200, unit: "mcg" },
            "Vitamina B12": { value: 2.5, unit: "mcg" }, "Biotina": { value: 50, unit: "mcg" }, "Colina": { value: 550, unit: "mg" },
            "Calcio": { value: 800, unit: "mg" }, "Cloro": { value: 800, unit: "mg" }, "Cobre": { value: 1, unit: "mg" },
            "Cromo": { value: 40, unit: "mcg" }, "Fósforo": { value: 700, unit: "mg" }, "Hierro": { value: 14, unit: "mg" },
            "Magnesio": { value: 375, unit: "mg" }, "Manganeso": { value: 2, unit: "mg" }, "Molibdeno": { value: 50, unit: "mcg" },
            "Potasio": { value: 2000, unit: "mg" }, "Selenio": { value: 55, unit: "mcg" }, "Sodio": { value: 2.4, unit: "g" },
            "Yodo": { value: 150, unit: "mcg" }, "Zinc": { value: 10, unit: "mg" }, "Omega-3": { value: 250, unit: "mg" },
            "Omega-6": { value: 10, unit: "g" }, "Omega-9 (Ácido Oleico)": { value: 20, unit: "g" }
        };

        // Referencias a elementos DOM para una manipulación más eficiente.
        const foodListDiv = document.getElementById('foodList');
        const searchInput = document.getElementById('searchFood');
        const sortCriteriaSelect = document.getElementById('sortCriteria');
        const sortDirectionSelect = document.getElementById('sortDirection');
        const micronutrientSortContainer = document.getElementById('micronutrientSortContainer');
        const sortMicronutrientSelect = document.getElementById('sortMicronutrient');
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmationMessage = document.getElementById('confirmationMessage');
        const confirmActionButton = document.getElementById('confirmActionButton');
        
        // Elementos del modal de detalle
        const foodDetailModal = document.getElementById('foodDetailModal');
        const detailNutrientTableBody = document.getElementById('detailNutrientTableBody');
        const detailQuantitySelector = document.getElementById('detailQuantitySelector');
        const detailCustomQuantityInput = document.getElementById('detailCustomQuantity');
        const detailUnitLabel = document.getElementById('detailUnitLabel');

        // Elementos del modal de edición
        const foodEditModal = document.getElementById('foodEditModal');
        const editMicronutrientTableBody = document.getElementById('editMicronutrientTable').getElementsByTagName('tbody')[0];
        const editUnitBaseSelect = document.getElementById('editUnitBase');
        const priceUnitLabel = document.getElementById('priceUnitLabel');
        const editPriceInput = document.getElementById('editPrice');
        const editCaloriesInput = document.getElementById('editCalories');
        const editProteinInput = document.getElementById('editProtein');
        const editCarbsInput = document.getElementById('editCarbs');
        const editFatInput = document.getElementById('editFat');
        const editSugarsInput = document.getElementById('editSugars');
        const editSaturatedFatInput = document.getElementById('editSaturatedFat');
        const deleteFoodBtn = document.getElementById('deleteFoodBtn');

        // Elementos para filtros avanzados
        const advancedFilterContainer = document.getElementById('advancedFilterContainer');
        const filterCaloriesMin = document.getElementById('filterCaloriesMin');
        const filterCaloriesMax = document.getElementById('filterCaloriesMax');
        const filterProteinMin = document.getElementById('filterProteinMin');
        const filterFatMax = document.getElementById('filterFatMax');
        const filterCarbsMin = document.getElementById('filterCarbsMin');
        const filterFiberMin = document.getElementById('filterFiberMin');
        const filterSugarMax = document.getElementById('filterSugarMax');
        const filterSaltMax = document.getElementById('filterSaltMax');
        const filterPriceMax = document.getElementById('filterPriceMax');
        const filterCategorySelect = document.getElementById('filterCategory');
        const filterSpecialCharacteristicsDiv = document.getElementById('filterSpecialCharacteristics');


        let currentEditingFoodIndex = -1; // Almacena el índice del alimento que se está editando o añadiendo.
        let displayedFoodCount = 100; // L_E_O: Cantidad de alimentos a mostrar inicialmente.
        const ITEMS_PER_LOAD = 100; // L_E_O: Cantidad de alimentos a cargar con el botón "Cargar Más".

        /**
         * Muestra una notificación "toast" en la parte inferior de la pantalla.
         * @param {string} message - El texto del mensaje a mostrar.
         */
        function showToast(message) {
            const toast = document.getElementById("toastNotification");
            toast.textContent = message;
            toast.className = "toast-notification show"; // Añade la clase 'show' para activar la animación.
            setTimeout(function(){
                toast.className = toast.className.replace("show", ""); // Elimina la clase 'show' después de un tiempo.
            }, 3000); // El toast desaparece después de 3 segundos.
        }

        /**
         * Calcula las calorías de un alimento basándose en sus macronutrientes.
         * Utiliza las proporciones estándar: 4 Kcal/g para proteínas y carbohidratos, 9 Kcal/g para grasas.
         * @param {object} food - El objeto alimento con propiedades protein, carbs y fat.
         * @returns {number} - Las calorías calculadas, redondeadas a un decimal.
         */
        function getCalculatedCalories(food) {
            const protein = parseFloat(food.protein) || 0;
            const carbs = parseFloat(food.carbs) || 0;
            const fat = parseFloat(food.fat) || 0;
            return parseFloat(((protein * 4) + (carbs * 4) + (fat * 9)).toFixed(1));
        }

        /**
         * Calcula y muestra las calorías en el campo de calorías del modal de edición.
         */
        function calculateAndDisplayCalories() {
            const food = {
                protein: document.getElementById('editProtein').value,
                carbs: document.getElementById('editCarbs').value,
                fat: document.getElementById('editFat').value
            };
            editCaloriesInput.value = getCalculatedCalories(food);
        }

        /**
         * Calcula el porcentaje del Valor Diario Recomendado (VDR) para un nutriente dado.
         * Realiza conversiones de unidades básicas (mcg/mg/g) si es necesario.
         * @param {number} nutrientValue - La cantidad del nutriente en el alimento.
         * @param {string} nutrientName - El nombre del nutriente (debe coincidir con las claves en dailyRecommendedValues).
         * @param {string} unit - La unidad de la cantidad del nutriente (ej. "mg", "mcg", "g").
         * @returns {string} - El porcentaje de VDR como cadena (ej. "80") o '-' si no hay VDR definido.
         */
        function calculateVDR(nutrientValue, nutrientName, unit) {
            let vdrTarget = dailyRecommendedValues[nutrientName];
            if (!vdrTarget) return '-'; // No hay VDR definido para este nutriente.

            let vdrValue = typeof vdrTarget === 'object' ? vdrTarget.value : vdrTarget;
            let vdrUnit = typeof vdrTarget === 'object' ? vdrTarget.unit : unit; 

            let nutrientValueInVdrUnit = nutrientValue;
            if (unit === 'mcg' && vdrUnit === 'mg') nutrientValueInVdrUnit /= 1000;
            else if (unit === 'mg' && vdrUnit === 'mcg') nutrientValueInVdrUnit *= 1000;
            else if (unit === 'mg' && vdrUnit === 'g') nutrientValueInVdrUnit /= 1000;
            else if (unit === 'g' && vdrUnit === 'mg') nutrientValueInVdrUnit *= 1000;
            else if (unit === 'g' && vdrUnit === 'mcg') nutrientValueInVdrUnit *= 1000000;
            else if (unit === 'mcg' && vdrUnit === 'g') nutrientValueInVdrUnit /= 1000000;

            if (vdrValue && vdrValue > 0) {
                return ((nutrientValueInVdrUnit / vdrValue) * 100).toFixed(0);
            }
            return '-'; // Si el VDR es cero o no válido.
        }

        /**
         * Valida que los valores de los macronutrientes sean coherentes y positivos.
         * Muestra mensajes de validación al usuario.
         * @returns {boolean} - True si todos los macronutrientes son válidos, false en caso contrario.
         */
        function validateMacronutrients() {
            const carbs = parseFloat(editCarbsInput.value) || 0;
            const sugars = parseFloat(editSugarsInput.value) || 0;
            const fat = parseFloat(editFatInput.value) || 0;
            const saturatedFat = parseFloat(editSaturatedFatInput.value) || 0;

            let isValid = true;
            
            const validateSubField = (subInput, mainValue, message) => {
                const subValue = parseFloat(subInput.value) || 0;
                if (subValue > mainValue) {
                    subInput.classList.add('invalid');
                    subInput.nextElementSibling.textContent = message;
                    subInput.nextElementSibling.style.display = 'block';
                    isValid = false;
                } else {
                    subInput.classList.remove('invalid');
                    subInput.nextElementSibling.style.display = 'none';
                }
            };
            
            validateSubField(editSugarsInput, carbs, 'Los azúcares no pueden ser mayores que los carbohidratos.');
            validateSubField(editSaturatedFatInput, fat, 'Las grasas saturadas no pueden ser mayores que las grasas totales.');

            return isValid;
        }

        /**
         * Renderiza las tarjetas de alimentos en la interfaz principal.
         * @param {Array<Object>} filteredAndSortedData - Los datos de alimentos ya filtrados y ordenados.
         */
        function renderFoodCards(filteredAndSortedData) {
            foodListDiv.innerHTML = ''; // Limpia las tarjetas existentes.
            const foodsToDisplay = filteredAndSortedData.slice(0, displayedFoodCount);

            foodsToDisplay.forEach((food) => {
                const displayUnit = food.unitBase;
                const priceUnitDisplay = displayUnit === 'g' ? 'kg' : 'L';

                const allMicrosWithVDR = Object.entries(food.micronutrients).map(([name, data]) => {
                    const vdr = calculateVDR(data.value, name, data.unit);
                    return { name, ...data, vdr: vdr !== '-' ? parseFloat(vdr) : -1 };
                });

                const topMicrosHtml = (type, title) => {
                    const micros = allMicrosWithVDR
                        .filter(m => m.type === type && m.vdr > 0)
                        .sort((a, b) => b.vdr - a.vdr)
                        .slice(0, 3);
                    
                    if (micros.length === 0) return '';
                    
                    let html = `<strong>${title}:</strong><ul>`;
                    micros.forEach(micro => {
                        html += `<li>${micro.name}: ${micro.value}${micro.unit} (${micro.vdr}%)</li>`;
                    });
                    html += '</ul>';
                    return html;
                };

                let micronutrientsHtml = topMicrosHtml('Vitamina', 'Vitaminas') + topMicrosHtml('Mineral', 'Minerales');
                if (micronutrientsHtml === '') {
                    micronutrientsHtml = '<p>No disponibles</p>';
                }

                const cardHtml = `
                    <div class="food-card" data-index="${foodData.indexOf(food)}" onclick="openDetailModal(${foodData.indexOf(food)})">
                        <h3>${food.name}</h3>
                        <div class="food-card-content">
                            <div class="left-column">
                                <p style="font-size: 0.8em; color: var(--light-text-color);">Por 100${displayUnit}</p>
                                <div class="nutrition-summary">
                                    <p><strong>Calorías:</strong> ${food.calories} Kcal</p>
                                    <p><strong>Proteínas:</strong> ${food.protein}g</p>
                                    <p><strong>Carbohidratos:</strong> ${food.carbs}g</p>
                                    <p class="sub-nutrient">de los cuales azúcares: ${food.sugars}g</p>
                                    <p><strong>Grasas:</strong> ${food.fat}g</p>
                                    <p class="sub-nutrient">de las cuales saturadas: ${food.saturatedFat}g</p>
                                    <p><strong>Fibra:</strong> ${food.fiber}g</p>
                                    <p><strong>Sal:</strong> ${food.salt}g</p>
                                </div>
                            </div>
                            <div class="right-column">
                                <div class="micronutrients-brief">
                                    ${micronutrientsHtml}
                                </div>
                                <p class="price">Precio: ${food.price.toFixed(2)} €/${priceUnitDisplay}</p>
                            </div>
                        </div>
                    </div>
                `;
                foodListDiv.insertAdjacentHTML('beforeend', cardHtml);
            });

            loadMoreBtn.style.display = filteredAndSortedData.length > displayedFoodCount ? 'block' : 'none';
        }

        /**
         * Incrementa la cantidad de alimentos a mostrar y vuelve a renderizar la lista.
         */
        function loadMoreFoods() {
            displayedFoodCount += ITEMS_PER_LOAD;
            filterAndSortFoods();
        }

        /**
         * Abre un modal específico.
         * @param {string} modalId - El ID del modal a abrir.
         */
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        /**
         * Cierra un modal específico.
         * @param {string} modalId - El ID del modal a cerrar.
         */
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        /**
         * Genera el HTML para una barra de progreso de VDR, con colores que indican el nivel.
         * @param {string} vdrPercent - El porcentaje de VDR como cadena (ej. "80").
         * @returns {string} - El HTML de la celda de la tabla con la barra de progreso.
         */
        function getVdrProgressBarHtml(vdrPercent) {
            if (vdrPercent === '-') {
                return `<div class="vdr-cell"><span class="vdr-text">-</span></div>`;
            }
            
            const percentValue = parseFloat(vdrPercent);
            let fillClass = 'low';
            if (percentValue >= 75) fillClass = 'high';
            else if (percentValue >= 25) fillClass = 'medium';
            if (percentValue > 100) fillClass = 'excess';

            const fillWidth = Math.min(percentValue, 100);

            return `
                <div class="vdr-cell">
                    <span class="vdr-text">${vdrPercent}%</span>
                    <div class="vdr-progress-bar">
                        <div class="vdr-progress-fill ${fillClass}" style="width: ${fillWidth}%;"></div>
                    </div>
                </div>
            `;
        }

        /**
         * Abre el modal de detalle para un alimento específico.
         * @param {number} index - El índice del alimento en el array `foodData`.
         */
        function openDetailModal(index) {
            const food = foodData[index];
            if (!food) return;

            currentEditingFoodIndex = index;

            document.getElementById('detailFoodName').textContent = food.name;
            document.getElementById('detailCategory').textContent = food.category || 'No especificada';
            document.getElementById('detailCharacteristics').textContent = food.characteristics && food.characteristics.length > 0 ? food.characteristics.join(', ') : 'Ninguna';
            const priceUnitDisplay = food.unitBase === 'g' ? 'kg' : 'L';
            document.getElementById('detailPrice').textContent = `${food.price.toFixed(2)} €/${priceUnitDisplay}`;


            detailQuantitySelector.value = "100";
            detailCustomQuantityInput.value = "100";
            detailCustomQuantityInput.style.display = 'none';

            updateDetailNutrients();
            
            openModal('foodDetailModal');
        }

        /**
         * Actualiza la tabla de nutrientes en el modal de detalle basándose en la cantidad seleccionada.
         */
        function updateDetailNutrients() {
            const food = foodData[currentEditingFoodIndex];
            if (!food) return;

            let quantity = 100;
            const selectedOption = detailQuantitySelector.value;
            
            if (selectedOption === "user") {
                detailCustomQuantityInput.style.display = 'inline-block';
                const customQty = parseFloat(detailCustomQuantityInput.value);
                if (!isNaN(customQty) && customQty > 0) {
                    quantity = customQty;
                }
            } else {
                detailCustomQuantityInput.style.display = 'none';
                quantity = parseFloat(selectedOption);
            }
            const quantityFactor = quantity / 100;

            detailUnitLabel.textContent = food.unitBase;
            
            detailNutrientTableBody.innerHTML = '';

            const nutrientsToShow = [
                { name: "Calorías", value: food.calories, unit: "Kcal", vdrKey: "calories" },
                { name: "Grasas", value: food.fat, unit: "g", vdrKey: "fat" },
                { name: "de las cuales saturadas", value: food.saturatedFat, unit: "g", vdrKey: "saturatedFat", isSub: true },
                { name: "Carbohidratos", value: food.carbs, unit: "g", vdrKey: "carbs" },
                { name: "de los cuales azúcares", value: food.sugars, unit: "g", vdrKey: "sugars", isSub: true },
                { name: "Fibra", value: food.fiber, unit: "g", vdrKey: "fiber" },
                { name: "Proteínas", value: food.protein, unit: "g", vdrKey: "protein" },
                { name: "Sal", value: food.salt, unit: "g", vdrKey: "salt" }
            ];

            nutrientsToShow.forEach(nutrient => {
                const row = document.createElement('tr');
                row.className = nutrient.isSub ? 'sub-nutrient-row' : '';
                const scaledValue = (nutrient.value * quantityFactor).toFixed(nutrient.unit === 'g' ? 1 : 0);
                const vdrPercent = calculateVDR(nutrient.value * quantityFactor, nutrient.vdrKey, nutrient.unit);
                row.innerHTML = `
                    <td>${nutrient.name}</td>
                    <td>${scaledValue}${nutrient.unit}</td>
                    <td>${getVdrProgressBarHtml(vdrPercent)}</td>
                `;
                detailNutrientTableBody.appendChild(row);
            });

            const vitamins = [], minerals = [], others = [];
            Object.entries(food.micronutrients).forEach(([name, data]) => {
                const item = { name, ...data };
                if (data.type === "Vitamina") vitamins.push(item);
                else if (data.type === "Mineral") minerals.push(item);
                else others.push(item);
            });

            const appendMicronutrientSection = (title, nutrientsArray) => {
                if (nutrientsArray.length > 0) {
                    const headerRow = detailNutrientTableBody.insertRow();
                    headerRow.className = 'section-divider';
                    headerRow.innerHTML = `<td colspan="3">${title}:</td>`;
                    
                    nutrientsArray.sort((a,b) => a.name.localeCompare(b.name)).forEach(nutrient => {
                        const row = document.createElement('tr');
                        const scaledValue = (nutrient.value * quantityFactor).toFixed(nutrient.unit === 'g' ? 2 : 1);
                        const vdrPercent = calculateVDR(nutrient.value * quantityFactor, nutrient.name, nutrient.unit);
                        row.innerHTML = `
                            <td class="micronutrient-name">${nutrient.name}</td>
                            <td>${scaledValue}${nutrient.unit}</td>
                            <td>${getVdrProgressBarHtml(vdrPercent)}</td>
                        `;
                        detailNutrientTableBody.appendChild(row);
                    });
                }
            };

            appendMicronutrientSection('Vitaminas', vitamins);
            appendMicronutrientSection('Minerales', minerals);
            appendMicronutrientSection('Otros Componentes', others);

            if (Object.keys(food.micronutrients).length === 0) {
                const row = detailNutrientTableBody.insertRow();
                row.innerHTML = `<td colspan="3" style="text-align: center; color: var(--light-text-color);">No se han añadido vitaminas o minerales.</td>`;
            }
        }

        /**
         * Abre el modal de edición para un alimento existente o para crear uno nuevo.
         * @param {number} index - El índice del alimento en `foodData` o -1 para un nuevo alimento.
         */
        function openEditModal(index) {
            currentEditingFoodIndex = index;
            const isNewFood = index === -1;
            const food = isNewFood ? {} : foodData[index];

            document.getElementById('editFoodNameHeader').textContent = isNewFood ? 'Nuevo Alimento' : food.name;
            document.getElementById('editFoodIndex').value = index;
            deleteFoodBtn.style.display = isNewFood ? 'none' : 'block';

            const editCategorySelect = document.getElementById('editCategory');
            editCategorySelect.innerHTML = '<option value="">Selecciona una categoría</option>';
            foodCategories.forEach(cat => {
                const isSelected = food.category === cat;
                editCategorySelect.innerHTML += `<option value="${cat}" ${isSelected ? 'selected' : ''}>${cat}</option>`;
            });

            const editCharacteristicsDiv = document.getElementById('editCharacteristics');
            editCharacteristicsDiv.innerHTML = '';
            specialCharacteristics.forEach(char => {
                const id = `editChar_${char.replace(/\s+/g, '')}`;
                const isChecked = !isNewFood && food.characteristics && food.characteristics.includes(char);
                editCharacteristicsDiv.innerHTML += `
                    <label for="${id}"><input type="checkbox" id="${id}" value="${char}" ${isChecked ? 'checked' : ''}> ${char}</label>`;
            });

            document.getElementById('editUnitLabel').textContent = isNewFood ? 'g' : food.unitBase;
            editUnitBaseSelect.value = isNewFood ? 'g' : food.unitBase;
            updatePriceInput(editUnitBaseSelect.value);

            document.getElementById('editName').value = food.name || '';
            editPriceInput.value = food.price || '';
            document.getElementById('editProtein').value = food.protein || '';
            document.getElementById('editCarbs').value = food.carbs || '';
            document.getElementById('editSugars').value = food.sugars || '';
            document.getElementById('editFat').value = food.fat || '';
            document.getElementById('editSaturatedFat').value = food.saturatedFat || '';
            document.getElementById('editFiber').value = food.fiber || '';
            document.getElementById('editSalt').value = food.salt || '';

            calculateAndDisplayCalories();
            
            editMicronutrientTableBody.innerHTML = '';
            if (!isNewFood) {
                Object.entries(food.micronutrients).sort((a, b) => a[0].localeCompare(b[0])).forEach(([name, data]) => {
                    addMicronutrientField(name, data.value, data.unit, data.type);
                });
            }
            if (editMicronutrientTableBody.rows.length === 0) {
                addMicronutrientField();
            }
            
            document.querySelectorAll('.validation-message').forEach(span => span.style.display = 'none');
            document.querySelectorAll('.form-group input, .form-group select').forEach(input => input.classList.remove('invalid'));

            openModal('foodEditModal');
        }

        /**
         * Cierra el modal de detalle y abre el modal de edición.
         */
        function openEditModalFromDetail() {
            closeModal('foodDetailModal');
            openEditModal(currentEditingFoodIndex);
        }

        /**
         * Actualiza la etiqueta de la unidad de precio (kg o L).
         * @param {string} unitBase - La unidad base seleccionada ("g" o "ml").
         */
        function updatePriceInput(unitBase) {
            priceUnitLabel.textContent = unitBase === 'g' ? 'kg' : 'L';
            document.getElementById('editUnitLabel').textContent = unitBase;
        }

        /**
         * Añade una nueva fila para un campo de micronutriente en el modal de edición.
         * @param {string} [currentName=''] - Nombre del micronutriente a precargar.
         * @param {number} [currentValue=''] - Valor del micronutriente a precargar.
         * @param {string} [currentUnit=''] - Unidad del micronutriente a precargar.
         * @param {string} [currentType=''] - Tipo del micronutriente a precargar.
         */
        function addMicronutrientField(currentName = '', currentValue = '', currentUnit = '', currentType = '') {
            const row = editMicronutrientTableBody.insertRow();
            row.className = 'micronutrient-input-row';

            const sortedAvailableMicros = [...availableMicronutrients].sort((a, b) => a.name.localeCompare(b.name));
            let optionsHtml = '<option value="">Selecciona un nutriente</option>';
            sortedAvailableMicros.forEach(micro => {
                const isSelected = micro.name === currentName;
                optionsHtml += `<option value="${micro.name}" data-unit="${micro.unit}" data-type="${micro.type}" ${isSelected ? 'selected' : ''}>${micro.name}</option>`;
            });

            const unitOptions = Array.from(new Set(availableMicronutrients.map(m => m.unit))).sort();
            let unitSelectHtml = unitOptions.map(unit => `<option value="${unit}" ${unit === currentUnit ? 'selected' : ''}>${unit}</option>`).join('');

            row.innerHTML = `
                <td><select class="micronutrient-name-select" onchange="updateMicronutrientData(this)">${optionsHtml}</select></td>
                <td>
                    <input type="number" step="0.01" min="0" placeholder="Cantidad" value="${currentValue}">
                    <select class="micronutrient-unit-select">${unitSelectHtml}</select>
                    <input type="hidden" class="micronutrient-type" value="${currentType}">
                </td>
                <td><button type="button" class="remove-btn" onclick="removeMicronutrientField(this)">&times;</button></td>
            `;
            updateDropdownOptions();
            updateAddButtonState();
        }

        /**
         * Elimina una fila de campo de micronutriente.
         * @param {HTMLElement} button - El botón que activó la eliminación.
         */
        function removeMicronutrientField(button) {
            button.closest('tr').remove();
            updateDropdownOptions();
            updateAddButtonState();
        }

        /**
         * Actualiza la unidad y el tipo del micronutriente cuando se cambia la selección.
         * @param {HTMLSelectElement} selectElement - El elemento <select> cuyo valor ha cambiado.
         */
        function updateMicronutrientData(selectElement) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const row = selectElement.closest('tr');
            const unitSelect = row.querySelector('.micronutrient-unit-select');
            const typeInput = row.querySelector('.micronutrient-type');
            if (selectedOption && selectedOption.value) {
                unitSelect.value = selectedOption.dataset.unit;
                typeInput.value = selectedOption.dataset.type;
            }
            updateDropdownOptions();
        }

        /**
         * Actualiza las opciones de todos los selectores de micronutrientes para evitar duplicados.
         */
        function updateDropdownOptions() {
            const allSelects = editMicronutrientTableBody.querySelectorAll('.micronutrient-name-select');
            const selectedNames = new Set(Array.from(allSelects).map(s => s.value).filter(Boolean));
            allSelects.forEach(select => {
                Array.from(select.options).forEach(option => {
                    option.disabled = selectedNames.has(option.value) && select.value !== option.value;
                });
            });
        }

        /**
         * Actualiza el estado del botón "Añadir Vitamina/Mineral".
         */
        function updateAddButtonState() {
            const addButton = document.querySelector('.add-micronutrient-btn');
            const selectedCount = new Set(Array.from(editMicronutrientTableBody.querySelectorAll('.micronutrient-name-select')).map(s => s.value).filter(Boolean)).size;
            addButton.disabled = selectedCount >= availableMicronutrients.length;
            addButton.textContent = addButton.disabled ? 'Todas las Vitaminas/Minerales añadidas' : '+ Añadir Vitamina/Mineral';
        }

        document.getElementById('editFoodForm').addEventListener('submit', function(event) {
            event.preventDefault();

            if (!validateFormFields() || !validateMacronutrients()) {
                showToast('Por favor, corrige los errores en el formulario.');
                return;
            }

            const index = parseInt(document.getElementById('editFoodIndex').value);
            const isNewFood = index === -1;
            let food = isNewFood ? { micronutrients: {}, characteristics: [] } : foodData[index];

            food.name = document.getElementById('editName').value.trim();
            food.unitBase = editUnitBaseSelect.value;
            food.price = parseFloat(editPriceInput.value);
            food.category = document.getElementById('editCategory').value;
            
            food.characteristics = Array.from(document.querySelectorAll('#editCharacteristics input:checked')).map(cb => cb.value);

            food.protein = parseFloat(document.getElementById('editProtein').value) || 0;
            food.carbs = parseFloat(document.getElementById('editCarbs').value) || 0;
            food.sugars = parseFloat(document.getElementById('editSugars').value) || 0;
            food.fat = parseFloat(document.getElementById('editFat').value) || 0;
            food.saturatedFat = parseFloat(document.getElementById('editSaturatedFat').value) || 0;
            food.fiber = parseFloat(document.getElementById('editFiber').value) || 0;
            food.salt = parseFloat(document.getElementById('editSalt').value) || 0;
            food.calories = getCalculatedCalories(food);

            food.micronutrients = {};
            editMicronutrientTableBody.querySelectorAll('.micronutrient-input-row').forEach(row => {
                const name = row.querySelector('.micronutrient-name-select').value;
                const value = parseFloat(row.querySelector('input[type="number"]').value);
                const unit = row.querySelector('.micronutrient-unit-select').value;
                const type = row.querySelector('.micronutrient-type').value;
                if (name && !isNaN(value) && value >= 0 && unit && type) {
                    food.micronutrients[name] = { value, unit, type };
                }
            });

            if (isNewFood) {
                foodData.push(food);
            }

            filterAndSortFoods();
            closeModal('foodEditModal');
            showToast(isNewFood ? '¡Alimento añadido con éxito!' : '¡Alimento actualizado con éxito!');
        });

        /**
         * Valida todos los campos requeridos del formulario de edición.
         * @returns {boolean} - True si todos los campos son válidos, false en caso contrario.
         */
        function validateFormFields() {
            let isValid = true;
            document.querySelectorAll('#editFoodForm [required]').forEach(input => {
                const messageSpan = input.nextElementSibling;
                if (!input.value.trim() || (input.type === 'number' && parseFloat(input.value) < 0)) {
                    input.classList.add('invalid');
                    messageSpan.textContent = !input.value.trim() ? 'Este campo es obligatorio.' : 'Debe ser un número positivo.';
                    messageSpan.style.display = 'block';
                    isValid = false;
                } else {
                    input.classList.remove('invalid');
                    messageSpan.style.display = 'none';
                }
            });
            return isValid;
        }

        /**
         * Muestra un modal de confirmación antes de eliminar un alimento.
         */
        function confirmDeleteFood() {
            closeModal('foodDetailModal');
            closeModal('foodEditModal');
            const foodName = foodData[currentEditingFoodIndex].name;
            confirmationMessage.innerHTML = `¿Estás seguro de que quieres eliminar <strong>${foodName}</strong>? Esta acción no se puede deshacer.`;
            confirmActionButton.onclick = deleteFood;
            openModal('confirmationModal');
        }

        /**
         * Elimina el alimento actualmente seleccionado.
         */
        function deleteFood() {
            foodData.splice(currentEditingFoodIndex, 1);
            closeModal('confirmationModal');
            filterAndSortFoods();
            showToast('¡Alimento eliminado con éxito!');
        }

        /**
         * Alterna la visibilidad del selector de micronutrientes para la ordenación.
         */
        function toggleMicronutrientSortSelect() {
            const criteria = sortCriteriaSelect.value;
            const show = ['vitamins', 'minerals', 'others'].includes(criteria);
            micronutrientSortContainer.style.display = show ? 'flex' : 'none';
            if (show) populateMicronutrientSortSelect(criteria);
        }

        /**
         * Rellena el selector de micronutrientes para la ordenación.
         * @param {string} type - El tipo de micronutriente a poblar ("vitamins", "minerals", "others").
         */
        function populateMicronutrientSortSelect(type) {
            sortMicronutrientSelect.innerHTML = '<option value="">Selecciona un nutriente</option>';
            const typeMap = { vitamins: 'Vitamina', minerals: 'Mineral' };
            const uniqueMicros = new Set();
            foodData.forEach(food => {
                Object.entries(food.micronutrients).forEach(([name, data]) => {
                    const match = type === 'others'
                        ? !Object.values(typeMap).includes(data.type)
                        : data.type === typeMap[type];
                    if (match) uniqueMicros.add(name);
                });
            });
            Array.from(uniqueMicros).sort().forEach(name => {
                sortMicronutrientSelect.innerHTML += `<option value="${name}">${name}</option>`;
            });
        }

        /**
         * Alterna la visibilidad de la sección de filtros avanzados.
         */
        function toggleAdvancedFilters() {
            advancedFilterContainer.classList.toggle('expanded');
            const toggleBtn = document.querySelector('.filter-toggle-btn');
            toggleBtn.textContent = advancedFilterContainer.classList.contains('expanded') 
                ? 'Ocultar Filtros Avanzados' 
                : 'Mostrar Filtros Avanzados';
        }

        /**
         * Restablece todos los campos de los filtros avanzados a sus valores por defecto.
         */
        function resetAdvancedFilters() {
            document.querySelectorAll('#advancedFilterContainer input, #advancedFilterContainer select').forEach(el => {
                if (el.type === 'checkbox') el.checked = false;
                else el.value = '';
            });
            filterAndSortFoods();
            showToast('Filtros avanzados restablecidos.');
        }

        /**
         * Aplica filtros y ordenación a la lista de alimentos y la renderiza.
         */
        function filterAndSortFoods() {
            const searchTerm = searchInput.value.toLowerCase();
            const sortBy = sortCriteriaSelect.value;
            const sortDir = sortDirectionSelect.value;
            const sortMicro = sortMicronutrientSelect.value;

            const filters = {
                caloriesMin: parseFloat(filterCaloriesMin.value), proteinMin: parseFloat(filterProteinMin.value),
                fatMax: parseFloat(filterFatMax.value), carbsMin: parseFloat(filterCarbsMin.value),
                fiberMin: parseFloat(filterFiberMin.value), sugarMax: parseFloat(filterSugarMax.value),
                saltMax: parseFloat(filterSaltMax.value), priceMax: parseFloat(filterPriceMax.value),
                category: filterCategorySelect.value,
                characteristics: Array.from(document.querySelectorAll('#filterSpecialCharacteristics input:checked')).map(cb => cb.value)
            };

            let displayedFoods = foodData.filter(food => {
                if (searchTerm && !food.name.toLowerCase().includes(searchTerm)) return false;
                if (!isNaN(filters.caloriesMin) && food.calories < filters.caloriesMin) return false;
                if (!isNaN(filters.proteinMin) && food.protein < filters.proteinMin) return false;
                if (!isNaN(filters.fatMax) && food.fat > filters.fatMax) return false;
                if (!isNaN(filters.carbsMin) && food.carbs < filters.carbsMin) return false;
                if (!isNaN(filters.fiberMin) && food.fiber < filters.fiberMin) return false;
                if (!isNaN(filters.sugarMax) && food.sugars > filters.sugarMax) return false;
                if (!isNaN(filters.saltMax) && food.salt > filters.saltMax) return false;
                if (!isNaN(filters.priceMax) && food.price > filters.priceMax) return false;
                if (filters.category && food.category !== filters.category) return false;
                if (filters.characteristics.length > 0 && !filters.characteristics.every(char => food.characteristics.includes(char))) return false;
                return true;
            });

            displayedFoods.sort((a, b) => {
                let valA, valB;
                if (['vitamins', 'minerals', 'others'].includes(sortBy) && sortMicro) {
                    valA = a.micronutrients[sortMicro]?.value || 0;
                    valB = b.micronutrients[sortMicro]?.value || 0;
                } else if (sortBy === 'name') {
                    return sortDir === 'asc' ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name);
                } else {
                    valA = a[sortBy] || 0;
                    valB = b[sortBy] || 0;
                }
                return sortDir === 'asc' ? valA - valB : valB - valA;
            });

            displayedFoodCount = ITEMS_PER_LOAD;
            renderFoodCards(displayedFoods);
        }

        /**
         * Exporta los datos de los alimentos a un archivo JSON.
         */
        function exportData() {
            foodData.forEach(food => food.calories = getCalculatedCalories(food)); // Asegura calorías actualizadas
            const dataStr = JSON.stringify(foodData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'alimentos.json';
            a.click();
            URL.revokeObjectURL(url);
            a.remove();
            showToast('¡Datos exportados con éxito!');
        }

        /**
         * Normaliza los datos de un alimento, especialmente para manejar inconsistencias en el JSON.
         * @param {object} food - El objeto alimento a normalizar.
         * @returns {object} - El objeto alimento normalizado.
         */
        function normalizeFoodData(food) {
            // Normaliza unitBase
            if (food.unitBase && typeof food.unitBase === 'string') {
                if (food.unitBase.includes('g')) food.unitBase = 'g';
                else if (food.unitBase.includes('ml')) food.unitBase = 'ml';
            } else {
                food.unitBase = 'g'; // Valor por defecto
            }

            // Normaliza valores nutricionales si la base no es 100 (ej. Ajo 10g)
            // Esta parte requeriría una lógica más compleja si el JSON tuviera un campo para la base (ej. "baseQty": 10)
            
            // Asegura que las propiedades numéricas existan y sean números
            ['protein', 'carbs', 'sugars', 'fat', 'saturatedFat', 'fiber', 'salt', 'price'].forEach(prop => {
                food[prop] = parseFloat(food[prop]) || 0;
            });

            // Calcula las calorías
            food.calories = getCalculatedCalories(food);

            // Asegura que micronutrients y characteristics sean objetos/arrays válidos
            food.micronutrients = food.micronutrients && typeof food.micronutrients === 'object' ? food.micronutrients : {};
            food.characteristics = Array.isArray(food.characteristics) ? food.characteristics : [];
            
            return food;
        }


        /**
         * Importa datos de alimentos desde un archivo JSON.
         * @param {Event} event - El evento de cambio del input de archivo.
         */
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (Array.isArray(imported) && imported.every(item => item.name && item.category)) {
                        foodData = imported.map(normalizeFoodData);
                        initUI();
                        showToast('¡Datos importados y normalizados con éxito!');
                    } else {
                        showToast('Error: El JSON importado no es un array válido de alimentos.');
                    }
                } catch (error) {
                    showToast('Error al procesar el archivo JSON.');
                    console.error('Error importing JSON:', error);
                }
            };
            reader.readAsText(file);
        }

        /**
         * Carga los datos iniciales desde el archivo alimentos.json.
         */
        async function loadFoodDataFromFile() {
            try {
                const response = await fetch('alimentos.json'); 
                if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
                
                const data = await response.json();
                if (Array.isArray(data)) {
                    foodData = data.map(normalizeFoodData);
                } else {
                     showToast('Error: alimentos.json no contiene un array.');
                }
            } catch (error) {
                console.error('No se pudo cargar alimentos.json:', error);
                showToast('No se pudo cargar la base de datos inicial.');
            } finally {
                initUI();
            }
        }
        
        /**
         * Inicializa y puebla los componentes de la UI (filtros, categorías, etc).
         */
        function initUI() {
            // Poblar filtros
            filterCategorySelect.innerHTML = '<option value="">Todas</option>';
            foodCategories.sort().forEach(cat => {
                filterCategorySelect.innerHTML += `<option value="${cat}">${cat}</option>`;
            });

            filterSpecialCharacteristicsDiv.innerHTML = '';
            specialCharacteristics.sort().forEach(char => {
                const id = `filterChar_${char.replace(/\s+/g, '')}`;
                filterSpecialCharacteristicsDiv.innerHTML += `
                    <label for="${id}"><input type="checkbox" id="${id}" value="${char}" onchange="filterAndSortFoods()"> ${char}</label>`;
            });

            toggleMicronutrientSortSelect();
            filterAndSortFoods();
        }

        // L_E_O: Configuración inicial al cargar el DOM.
        document.addEventListener('DOMContentLoaded', loadFoodDataFromFile);
    </script>
</body>
</html>
