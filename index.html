<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Base de Datos de Alimentos - Control Dietas</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Variables CSS para facilitar la personalización y la gestión del tema (claro/oscuro) */
        :root {
            --background-color: #f8f8f8; /* Gris muy claro para el fondo principal */
            --card-background: #ffffff; /* Blanco puro para las tarjetas de alimentos y modales */
            --text-color: #333333; /* Gris oscuro para el texto principal */
            --light-text-color: #666666; /* Gris medio para texto secundario y etiquetas */
            --primary-color: #007bff; /* Azul estándar y profesional para elementos interactivos y títulos */
            --primary-light: #e0f2ff; /* Azul claro para fondos sutiles y bordes de resaltado */
            --border-color: #e9e9e9; /* Gris claro para bordes de elementos */
            --shadow-color: rgba(0, 0, 0, 0.08); /* Sombra suave para profundidad */
            --modal-backdrop: rgba(0, 0, 0, 0.6); /* Fondo oscuro semitransparente para modales */
            --success-color: #28a745; /* Verde para mensajes de éxito */
            --error-color: #dc3545; /* Rojo para errores y acciones destructivas */
            --progress-bar-bg: #e9ecef; /* Gris claro para el fondo de las barras de progreso */
            --progress-bar-fill-low: #ffc107; /* Amarillo para VDR bajo */
            --progress-bar-fill-medium: #17a2b8; /* Cyan para VDR medio */
            --progress-bar-fill-high: #28a745; /* Verde para VDR alto (ideal) */
            --progress-bar-fill-excess: #dc3545; /* Rojo para VDR en exceso */
        }

        /* Estilos globales del cuerpo */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            justify-content: center; /* Centra el contenido en pantallas grandes */
            min-height: 100vh; /* Ocupa al menos el 100% de la altura de la ventana */
        }

        /* Contenedor principal para limitar el ancho del contenido */
        .container {
            width: 100%; /* Utiliza el ancho completo disponible */
            max-width: 1920px; /* Ancho máximo aumentado para pantallas muy anchas */
            padding: 0 20px; /* Espaciado lateral */
        }

        /* Título principal de la página */
        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 40px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        /* --- Controles y Botones de Acción (Importar/Exportar, Buscar, Ordenar) --- */
        .controls-and-buttons {
            display: flex;
            flex-wrap: wrap; /* Permite que los elementos se envuelvan en pantallas pequeñas */
            justify-content: center;
            align-items: center;
            gap: 15px; /* Espacio entre los elementos */
            margin-bottom: 30px;
            padding: 15px;
            background-color: var(--card-background);
            border-radius: 10px;
            box-shadow: 0 2px 8px var(--shadow-color);
        }

        .action-buttons .btn {
            margin: 0 5px; /* Margen ajustado para los botones de acción */
        }
        .action-buttons input[type="file"] {
            display: none; /* Oculta el input de archivo por defecto */
        }

        /* Contenedores para la búsqueda, ordenación y control de filtros */
        .search-container, .sort-container, .filter-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        /* Estilos para inputs de texto, números y selectores dentro de los controles */
        .search-container input[type="text"],
        .sort-container select,
        .filter-control input[type="number"],
        .filter-control select {
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 0.95em;
            color: var(--text-color);
            background-color: var(--background-color);
            min-width: 150px; /* Ancho mínimo para legibilidad */
        }
        /* Efecto de foco para inputs y selects */
        .search-container input:focus,
        .sort-container select:focus,
        .filter-control input:focus,
        .filter-control select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15); /* Sombra suave al enfocar */
        }
        /* Estilos para las etiquetas de los controles */
        .control-label {
            font-weight: 500;
            color: var(--light-text-color);
            font-size: 0.9em;
            white-space: nowrap; /* Evita que el texto de la etiqueta se rompa */
        }

        /* --- Sección de Filtros Avanzados --- */
        .advanced-filter-container {
            margin-top: 20px;
            padding: 20px;
            background-color: var(--card-background);
            border-radius: 10px;
            box-shadow: 0 2px 8px var(--shadow-color);
            overflow: hidden; /* Oculta el contenido extra durante la transición */
            transition: max-height 0.4s ease-out, padding 0.4s ease-out, opacity 0.4s ease-out; /* Transiciones suaves */
            max-height: 0; /* Por defecto oculto */
            visibility: hidden; /* Oculta completamente cuando colapsado */
            opacity: 0; /* Desvanece el contenido */
        }

        /* Estado expandido para los filtros avanzados */
        .advanced-filter-container.expanded {
            max-height: 1000px; /* Suficientemente grande para mostrar todo el contenido */
            visibility: visible;
            opacity: 1;
            padding: 20px; /* Asegura que el padding se aplique al expandir */
        }

        /* Botón para alternar la visibilidad de los filtros avanzados */
        .filter-toggle-btn {
            background-color: var(--primary-light);
            color: var(--primary-color);
            border: 1px dashed var(--primary-color);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
            transition: background-color 0.2s ease;
            display: block; /* Elemento de bloque para centrar */
            width: fit-content; /* Ajusta el ancho al contenido */
            margin: 0 auto 20px; /* Centra el botón y añade margen inferior */
        }
        .filter-toggle-btn:hover {
            background-color: #d0e8ff; /* Color de fondo al pasar el ratón */
        }
        
        /* Contenedor de cuadrícula para los grupos de filtros */
        .advanced-filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Columnas responsivas */
            gap: 20px; /* Espacio entre grupos de filtros */
        }
        
        /* Estilos para cada grupo de filtros (ej. Macronutrientes, Características) */
        .filter-group {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            background-color: var(--background-color);
        }

        .filter-group h4 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 15px;
            font-weight: 600;
            font-size: 1.1em;
            border-bottom: 1px dashed var(--border-color);
            padding-bottom: 8px;
        }

        /* Control individual dentro de un grupo de filtros */
        .filter-control {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* Alinea etiquetas e inputs */
            gap: 5px;
        }
        .filter-control label {
            font-size: 0.9em;
            color: var(--light-text-color);
            font-weight: 500;
            margin-bottom: 3px;
        }
        .filter-control input[type="number"] {
            width: calc(100% - 22px); /* Ajusta el ancho por padding y borde */
            min-width: unset; /* Sobrescribe el min-width global para inputs más pequeños */
        }
        .filter-control .checkbox-group {
            display: flex;
            flex-wrap: wrap; /* Permite que los checkboxes se envuelvan */
            gap: 10px 15px; /* Espacio entre checkboxes */
        }
        .filter-control .checkbox-group label {
            display: flex;
            align-items: center;
            font-size: 0.9em;
            color: var(--text-color);
            cursor: pointer;
            gap: 5px;
        }
        .filter-control .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
            transform: scale(1.1); /* Ligeramente más grande para mejor visibilidad */
        }

        /* Acciones de los filtros (ej. Restablecer) */
        .filter-actions {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end; /* Alinea los botones a la derecha */
            gap: 10px;
        }

        /* --- Lista de Alimentos (Diseño de cuadrícula para tarjetas horizontales) --- */
        .food-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(500px, 1fr)); /* Columnas responsivas con min-width de 500px */
            gap: 25px; /* Espacio entre tarjetas */
            padding: 20px 0;
        }

        /* --- Tarjeta de Alimento (Diseño Horizontal) --- */
        .food-card {
            background-color: var(--card-background);
            border-radius: 10px;
            box-shadow: 0 4px 12px var(--shadow-color);
            padding: 20px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 1px solid var(--border-color);
            display: flex; /* Contenedor flex para la estructura interna */
            flex-direction: column; /* Diseño en columna para el encabezado y el contenido */
            align-items: flex-start; /* Alinea los elementos al inicio */
        }

        .food-card:hover {
            transform: translateY(-5px); /* Efecto de elevación al pasar el ratón */
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
        }

        .food-card h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--primary-color); /* Resalta el nombre del producto */
            font-weight: 700;
            font-size: 1.5em; /* Título más grande */
            width: 100%; /* Ancho completo para el encabezado */
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-light); /* Separador visual */
        }

        .food-card-content {
            display: flex; /* Contenedor flex interno para las dos columnas */
            flex-direction: row; /* Elementos internos en horizontal */
            width: 100%;
            gap: 20px; /* Espacio entre las dos columnas */
            flex-grow: 1; /* Permite que el contenido se expanda */
        }

        .food-card .left-column {
            flex: 1; /* Ocupa el espacio disponible */
            min-width: 220px; /* Ancho mínimo para legibilidad */
            display: flex;
            flex-direction: column;
        }

        .food-card .right-column {
            flex: 1; /* Ocupa el espacio disponible */
            min-width: 220px; /* Ancho mínimo para legibilidad */
            display: flex;
            flex-direction: column;
            border-left: 1px dashed var(--border-color); /* Separador visual */
            padding-left: 20px;
            align-self: stretch; /* Se estira para llenar la altura */
        }

        .food-card p {
            margin: 3px 0;
            font-size: 0.95em;
            color: var(--light-text-color);
            word-wrap: break-word; /* Permite que las palabras largas se rompan */
            overflow-wrap: break-word; /* Asegura el salto de palabras completo */
        }

        .food-card p strong {
            color: var(--text-color);
        }

        .food-card .nutrition-summary {
            margin-top: 5px;
            flex-grow: 1; /* Permite que crezca y empuje el precio hacia abajo */
        }
        
        .food-card .nutrition-summary p.sub-nutrient {
            margin-left: 15px; /* Sangría para sub-nutrientes */
            font-size: 0.9em;
            color: var(--light-text-color);
        }

        .food-card .micronutrients-brief {
            font-size: 0.9em;
            color: var(--light-text-color);
            margin-top: 0;
            padding-top: 0;
            flex-grow: 1;
        }

        .food-card .micronutrients-brief strong {
            display: block;
            margin-bottom: 8px;
            color: var(--text-color);
            font-size: 1em;
            border-bottom: 1px dashed var(--primary-light);
            padding-bottom: 5px;
        }
        .food-card .micronutrients-brief ul {
            list-style: none; /* Elimina los puntos de lista */
            padding: 0;
            margin: 0;
        }
        .food-card .micronutrients-brief li {
            margin-bottom: 5px;
            font-size: 0.9em;
            color: var(--light-text-color);
        }

        .food-card .price {
            font-size: 1.05em;
            font-weight: 600;
            color: var(--primary-color);
            margin-top: auto; /* Empuja el precio al final de su columna */
            text-align: right;
            padding-top: 10px;
            border-top: 1px dashed var(--border-color);
            padding-right: 0;
            padding-bottom: 0;
        }

        /* --- Paginación/Cargar Más --- */
        .load-more-container {
            text-align: center;
            margin-top: 30px;
            margin-bottom: 50px;
        }

        /* --- Estilo de los Modales --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-backdrop);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Asegura que esté sobre otros elementos */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--card-background);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 30px var(--shadow-color);
            width: 90%;
            max-width: 750px; /* Modal más ancho para mejor uso del espacio */
            position: relative;
            transform: translateY(20px); /* Efecto de entrada suave */
            transition: transform 0.3s ease;
            max-height: 90vh; /* Altura máxima del modal */
            overflow-y: auto; /* Permite desplazamiento si el contenido es largo */
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        .modal-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.8em;
            cursor: pointer;
            color: var(--light-text-color);
            transition: color 0.2s;
        }

        .modal-close-btn:hover {
            color: var(--text-color);
        }

        .modal-content h2 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 25px;
            font-weight: 700;
            font-size: 1.8em;
        }

        .modal-content .section-title {
            font-weight: 600;
            color: var(--text-color);
            margin-top: 25px;
            margin-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
            font-size: 1.1em;
        }

        .modal-content p strong {
            color: var(--text-color);
        }

        /* --- Estilo de la Tabla --- */
        .nutrient-table {
            width: 100%;
            border-collapse: collapse; /* Colapsa los bordes de las celdas */
            margin-top: 15px;
            font-size: 0.95em;
        }
        .nutrient-table th, .nutrient-table td {
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            text-align: left;
        }
        .nutrient-table th {
            background-color: var(--primary-light);
            color: var(--primary-color);
            font-weight: 600;
            white-space: nowrap; /* Evita que el texto de los encabezados se envuelva */
        }
        .nutrient-table tbody tr:nth-child(even) {
            background-color: #fcfcfc; /* Rayas de cebra para filas pares */
        }
        .nutrient-table tbody tr:hover {
            background-color: #f5f5f5; /* Efecto de resaltado al pasar el ratón */
        }
        .nutrient-table td:nth-child(2), /* Columna de valor */
        .nutrient-table td:nth-child(3) { /* Columna de %VDR */
            text-align: right;
            font-weight: 500;
            white-space: nowrap; /* Evita que los valores se envuelvan */
        }
        .nutrient-table .sub-nutrient-row td {
            padding-left: 30px; /* Sangría para sub-nutrientes */
            font-size: 0.9em;
            color: var(--light-text-color);
        }
        .nutrient-table .sub-nutrient-row td strong {
            color: var(--text-color);
        }
        .nutrient-table .micronutrient-name {
            font-weight: 500;
            color: var(--text-color);
        }
        .nutrient-table .section-divider td {
            background-color: var(--primary-light);
            color: var(--primary-color);
            font-weight: 600;
            text-align: center;
            border-top: 2px solid var(--primary-color);
            margin-top: 15px;
            padding-top: 15px;
            font-size: 1em;
        }

        /* --- Estilo de la Barra de Progreso VDR --- */
        .vdr-cell {
            display: flex;
            align-items: center;
            justify-content: flex-end; /* Alinea a la derecha para los valores */
            gap: 8px; /* Espacio entre texto y barra */
            min-width: 120px; /* Asegura suficiente espacio para la barra y el texto */
        }

        .vdr-progress-bar {
            width: 80px; /* Ancho fijo para la barra */
            height: 10px;
            background-color: var(--progress-bar-bg);
            border-radius: 5px;
            overflow: hidden;
        }

        .vdr-progress-fill {
            height: 100%;
            border-radius: 5px;
            width: 0%; /* El ancho se establecerá con JS */
            transition: width 0.5s ease-out;
        }

        .vdr-text {
            min-width: 35px; /* Asegura que el texto como "100%" quepa */
            text-align: right;
        }

        /* Colores de la barra de progreso basados en el valor */
        .vdr-progress-fill.low { background-color: var(--progress-bar-fill-low); } /* < 25% */
        .vdr-progress-fill.medium { background-color: var(--progress-bar-fill-medium); } /* 25-75% */
        .vdr-progress-fill.high { background-color: var(--progress-bar-fill-high); } /* 75-100% */
        .vdr-progress-fill.excess { background-color: var(--progress-bar-fill-excess); } /* > 100% */

        /* Acciones de los modales (botones en la parte inferior) */
        .modal-actions {
            margin-top: 35px;
            text-align: right;
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
            display: flex; /* Para alinear los botones */
            justify-content: space-between; /* Espacia el botón de eliminar y los de guardar/cancelar */
            align-items: center;
        }
        .modal-actions .right-actions {
            display: flex;
            gap: 10px;
        }

        /* Estilo general de los botones */
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: background-color 0.2s ease, transform 0.1s ease;
            margin-left: 10px;
            letter-spacing: 0.2px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #0069d9; /* Azul más oscuro al pasar el ratón */
            transform: translateY(-1px);
        }

        .btn-secondary {
            background-color: #f0f0f0;
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background-color: #e0e0e0;
            transform: translateY(-1px);
        }

        .btn-danger {
            background-color: var(--error-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333; /* Rojo más oscuro al pasar el ratón */
            transform: translateY(-1px);
        }

        /* --- Estilo de Formularios --- */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--light-text-color);
            font-size: 0.95em;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group select { /* Aplica estilos también a los selectores */
            width: calc(100% - 24px); /* Considera el padding en el ancho */
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 1em;
            color: var(--text-color);
            background-color: var(--card-background);
            box-sizing: border-box; /* Crucial para que el ancho del select funcione correctamente */
        }
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
        }
        /* Retroalimentación de validación */
        .form-group input.invalid, .form-group select.invalid {
            border-color: var(--error-color);
        }
        .form-group .validation-message {
            color: var(--error-color);
            font-size: 0.85em;
            margin-top: 5px;
            display: none; /* Oculto por defecto */
        }
        .form-group input.invalid + .validation-message,
        .form-group select.invalid + .validation-message {
            display: block; /* Muestra el mensaje si el campo es inválido */
        }

        /* Inputs de Micronutrientes Dinámicos (Modal de Edición) */
        .micronutrient-inputs table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .micronutrient-inputs th, .micronutrient-inputs td {
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            text-align: left;
        }
        .micronutrient-inputs th {
            background-color: var(--primary-light);
            color: var(--primary-color);
            font-weight: 600;
        }
        .micronutrient-inputs td input[type="number"] { /* Específico para input de número */
            width: calc(100% - 70px); /* Ajusta por el selector de unidad y padding */
            box-sizing: border-box; /* Incluye padding/borde en el ancho */
            margin: 0;
            padding: 8px;
            display: inline-block;
            vertical-align: middle;
        }
        .micronutrient-inputs td select.micronutrient-unit-select { /* Específico para selector de unidades */
            width: auto; /* Permite ancho automático basado en el contenido */
            padding: 8px;
            margin-left: 5px;
            display: inline-block; /* Mantiene junto al input */
            vertical-align: middle;
        }
        .micronutrient-inputs .remove-btn {
            background: none;
            border: none;
            color: var(--error-color);
            font-size: 1.5em;
            cursor: pointer;
            padding: 0 5px;
            transition: color 0.2s;
            width: 30px; /* Ancho fijo para la columna del botón */
        }
        .micronutrient-inputs .remove-btn:hover {
            color: #b02a37;
        }
        .add-micronutrient-btn {
            background-color: var(--primary-light);
            color: var(--primary-color);
            border: 1px dashed var(--primary-color);
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
            transition: background-color 0.2s ease;
            margin-top: 15px;
        }
        .add-micronutrient-btn:hover {
            background-color: #d0e8ff;
        }
        .micronutrient-inputs .unit-display {
            display: inline-block;
            margin-left: 5px;
            font-weight: 500;
            color: var(--light-text-color);
        }

        /* Estilos para las notificaciones "toast" */
        .toast-notification {
            visibility: hidden; /* Oculto por defecto */
            min-width: 250px;
            background-color: var(--text-color); /* Fondo oscuro */
            color: #fff; /* Texto blanco */
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 1001; /* Por encima de los modales */
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.5s, visibility 0.5s;
            box-shadow: 0 4px 12px var(--shadow-color);
            font-weight: 500;
        }

        .toast-notification.show {
            visibility: visible;
            opacity: 1;
            animation: fadein 0.5s, fadeout 0.5s 2.5s; /* Animación de entrada y salida */
        }

        /* Keyframe animations para el toast */
        @keyframes fadein {
            from {bottom: 0; opacity: 0;}
            to {bottom: 30px; opacity: 1;}
        }

        @keyframes fadeout {
            from {bottom: 30px; opacity: 1;}
            to {bottom: 0; opacity: 0;}
        }

        /* Dark Mode (opcional, para un ejemplo completo) */
        @media (prefers-color-scheme: dark) {
            :root {
                --background-color: #1e1e1e;
                --card-background: #2b2b2b;
                --text-color: #e0e0e0;
                --light-text-color: #b0b0b0;
                --primary-color: #6daffb; /* Azul más claro para modo oscuro */
                --primary-light: #3a5c7f;
                --border-color: #3e3e3e;
                --shadow-color: rgba(0, 0, 0, 0.3);
                --modal-backdrop: rgba(0, 0, 0, 0.75);
                --progress-bar-bg: #4a4a4a;
                --progress-bar-fill-low: #d4a017;
                --progress-bar-fill-medium: #1f94a7;
                --progress-bar-fill-high: #218838;
                --progress-bar-fill-excess: #a52a2a;
            }
            .food-card h3 { color: var(--primary-color); }
            .food-card p strong { color: var(--text-color); }
            .food-card p, .food-card .micronutrients-brief { color: var(--light-text-color); }
            .food-card .nutrition-summary p.sub-nutrient { color: var(--light-text-color); }
            .modal-content h2, .modal-content .section-title, .filter-group h4 { color: var(--primary-color); }
            .modal-close-btn { color: var(--light-text-color); }
            .btn-secondary { background-color: #3a3a3a; color: var(--text-color); border: 1px solid var(--border-color); }
            .btn-secondary:hover { background-color: #4a4a4a; }
            .form-group label, .filter-control label { color: var(--light-text-color); }
            .form-group input, .form-group select, .filter-control input, .filter-control select {
                background-color: #3a3a3a;
                color: var(--text-color);
                border-color: #4a4a4a;
            }
            .form-group input:focus, .form-group select:focus, .filter-control input:focus, .filter-control select:focus {
                border-color: var(--primary-color);
                box-shadow: 0 0 0 3px rgba(109, 175, 251, 0.15);
            }
            .add-micronutrient-btn, .filter-toggle-btn {
                background-color: var(--primary-light);
                color: var(--primary-color);
                border: 1px dashed var(--primary-color);
            }
            .add-micronutrient-btn:hover, .filter-toggle-btn:hover { background-color: #4a6c90; }
            .nutrient-table th { background-color: var(--primary-light); color: var(--primary-color); }
            .nutrient-table tbody tr:nth-child(even) { background-color: #333333; }
            .nutrient-table tbody tr:hover { background-color: #444444; }
            .nutrient-table .micronutrient-name { color: var(--text-color); }
            .nutrient-table td { color: var(--light-text-color); }
            .nutrient-table td strong { color: var(--text-color); }
            .nutrient-table .section-divider td { background-color: var(--primary-light); color: var(--primary-color); }
            .micronutrient-inputs th, .micronutrient-inputs td { border-color: var(--border-color); }
            .micronutrient-inputs th { background-color: var(--primary-light); color: var(--primary-color); }
            .micronutrient-inputs td input, .micronutrient-inputs td select {
                background-color: #3a3a3a;
                color: var(--text-color);
                border-color: #4a4a4a;
            }
            .micronutrient-inputs .unit-display { color: var(--light-text-color); }
            .filter-group { background-color: #2a2a2a; }
            .toast-notification { background-color: #3a3a3a; color: #e0e0e0; }
        }

        /* Ajustes responsivos */
        @media (max-width: 767px) {
            .food-list {
                grid-template-columns: 1fr; /* Una tarjeta por fila en pantallas pequeñas */
                padding: 10px 0;
            }
            .food-card { padding: 15px; }
            .food-card-content {
                flex-direction: column; /* Apila las columnas verticalmente en pantallas pequeñas */
                gap: 15px;
            }
            .food-card .right-column {
                border-left: none;
                border-top: 1px dashed var(--border-color); /* Borde superior en lugar del izquierdo */
                padding-left: 0;
                padding-top: 15px;
                margin-top: 0;
            }
            .food-card .price {
                text-align: left; /* Alinea el precio a la izquierda en móviles */
                border-top: none;
                padding-top: 0;
            }
            .controls-and-buttons {
                flex-direction: column;
                gap: 10px;
                padding: 10px;
            }
            .controls-and-buttons > div {
                width: 100%; /* Búsqueda/ordenación ocupan el ancho completo */
                justify-content: center;
            }
            .search-container input, .sort-container select {
                width: calc(100% - 20px); /* Ajusta el ancho por el padding interno */
                max-width: none;
                min-width: unset;
            }
            .advanced-filter-grid {
                grid-template-columns: 1fr; /* Apila los grupos de filtros verticalmente */
            }
        }
        /* Media query para pantallas medianas, permite 2 tarjetas con un ancho mínimo decente */
        @media (min-width: 768px) and (max-width: 1259px) { 
            .food-list {
                grid-template-columns: repeat(auto-fill, minmax(450px, 1fr)); /* Ligeramente más pequeño para 2 columnas */
            }
        }

        /* Media query para pantallas grandes, vuelve al min-width de 500px */
        @media (min-width: 1260px) { 
            .food-list {
                grid-template-columns: repeat(auto-fill, minmax(500px, 1fr)); 
            }
        }

    </style>
</head>
<body>

    <div class="container">
        <h1>Base de Datos de Alimentos</h1>

        <div class="controls-and-buttons">
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openEditModal(-1)">+ Añadir Alimento</button>
                <button class="btn btn-secondary" onclick="document.getElementById('importFileInput').click()">Importar Datos</button>
                <input type="file" id="importFileInput" accept=".json" onchange="importData(event)">
                <button class="btn btn-primary" onclick="exportData()">Exportar Datos</button>
            </div>

            <div class="search-container">
                <label for="searchFood" class="control-label">Buscar:</label>
                <input type="text" id="searchFood" placeholder="Buscar alimento..." oninput="filterAndSortFoods()">
            </div>

            <div class="sort-container">
                <label for="sortCriteria" class="control-label">Ordenar por:</label>
                <select id="sortCriteria" onchange="toggleMicronutrientSortSelect(); filterAndSortFoods()">
                    <option value="name">Nombre</option>
                    <option value="calories">Calorías</option>
                    <option value="protein">Proteínas</option>
                    <option value="fat">Grasas</option>
                    <option value="carbs">Carbohidratos</option>
                    <option value="fiber">Fibra</option>
                    <option value="vitamins">Vitaminas</option>
                    <option value="minerals">Minerales</option>
                    <option value="others">Otros</option>
                </select>

                <label for="sortDirection" class="control-label">Dirección:</label>
                <select id="sortDirection" onchange="filterAndSortFoods()">
                    <option value="asc">Ascendente</option>
                    <option value="desc">Descendente</option>
                </select>

                <div id="micronutrientSortContainer" style="display: none;">
                    <label for="sortMicronutrient" class="control-label">Nutriente Específico:</label>
                    <select id="sortMicronutrient" onchange="filterAndSortFoods()">
                        </select>
                </div>
            </div>
        </div>

        <button class="filter-toggle-btn" onclick="toggleAdvancedFilters()">Mostrar Filtros Avanzados</button>

        <div id="advancedFilterContainer" class="advanced-filter-container">
            <div class="advanced-filter-grid">
                <div class="filter-group">
                    <h4>Macronutrientes</h4>
                    <div class="filter-control">
                        <label for="filterCaloriesMin">Calorías (Kcal) Mín:</label>
                        <input type="number" id="filterCaloriesMin" step="1" min="0" oninput="filterAndSortFoods()">
                        <label for="filterCaloriesMax">Calorías (Kcal) Máx:</label>
                        <input type="number" id="filterCaloriesMax" step="1" min="0" oninput="filterAndSortFoods()">
                    </div>
                    <div class="filter-control">
                        <label for="filterProteinMin">Proteínas (g) Mín:</label>
                        <input type="number" id="filterProteinMin" step="0.1" min="0" oninput="filterAndSortFoods()">
                    </div>
                    <div class="filter-control">
                        <label for="filterFatMax">Grasas (g) Máx:</label>
                        <input type="number" id="filterFatMax" step="0.1" min="0" oninput="filterAndSortFoods()">
                    </div>
                    <div class="filter-control">
                        <label for="filterCarbsMin">Carbohidratos (g) Mín:</label>
                        <input type="number" id="filterCarbsMin" step="0.1" min="0" oninput="filterAndSortFoods()">
                    </div>
                    <div class="filter-control">
                        <label for="filterFiberMin">Fibra (g) Mín:</label>
                        <input type="number" id="filterFiberMin" step="0.1" min="0" oninput="filterAndSortFoods()">
                    </div>
                    <div class="filter-control">
                        <label for="filterSugarMax">Azúcares (g) Máx:</label>
                        <input type="number" id="filterSugarMax" step="0.1" min="0" oninput="filterAndSortFoods()">
                    </div>
                    <div class="filter-control">
                        <label for="filterSaltMax">Sal (g) Máx:</label>
                        <input type="number" id="filterSaltMax" step="0.01" min="0" oninput="filterAndSortFoods()">
                    </div>
                </div>

                <div class="filter-group">
                    <h4>Características Especiales</h4>
                    <div class="filter-control checkbox-group" id="filterSpecialCharacteristics">
                        </div>
                </div>

                <div class="filter-group">
                    <h4>Otros Filtros</h4>
                    <div class="filter-control">
                        <label for="filterPriceMax">Precio (€/kg o €/L) Máx:</label>
                        <input type="number" id="filterPriceMax" step="0.01" min="0" oninput="filterAndSortFoods()">
                    </div>
                    <div class="filter-control">
                        <label for="filterCategory">Categoría:</label>
                        <select id="filterCategory" onchange="filterAndSortFoods()">
                            <option value="">Todas</option>
                            </select>
                    </div>
                </div>
            </div>
            <div class="filter-actions">
                <button class="btn btn-secondary" onclick="resetAdvancedFilters()">Restablecer Filtros</button>
            </div>
        </div>

        <div class="food-list" id="foodList">
            </div>

        <div class="load-more-container">
            <button class="btn btn-secondary" id="loadMoreBtn" style="display: none;" onclick="loadMoreFoods()">Cargar Más Alimentos</button>
        </div>
    </div>

    <div id="foodDetailModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeModal('foodDetailModal')">&times;</button>
            <h2 id="detailFoodName"></h2>
            <p style="text-align: right; color: var(--light-text-color); margin-top: -15px;">Valores por 
                <select id="detailQuantitySelector" onchange="updateDetailNutrients()">
                    <option value="100">100g/ml</option>
                    <option value="200">200g/ml</option>
                    <option value="user">Personalizado</option>
                </select>
                <span id="detailUnitLabel"></span>
                <input type="number" id="detailCustomQuantity" step="1" min="1" value="100" style="width: 80px; margin-left: 10px; display: none;" oninput="updateDetailNutrients()">
            </p>

            <p class="section-title">Información General:</p>
            <p><strong>Categoría:</strong> <span id="detailCategory"></span></p>
            <p><strong>Características:</strong> <span id="detailCharacteristics"></span></p>

            <p class="section-title">Información Nutricional:</p>
            <table class="nutrient-table">
                <thead>
                    <tr>
                        <th>Nutriente</th>
                        <th>Cantidad</th>
                        <th>% VDR</th>
                    </tr>
                </thead>
                <tbody id="detailNutrientTableBody">
                    </tbody>
            </table>

            <div class="modal-actions">
                <button class="btn btn-danger" onclick="confirmDeleteFood()">Eliminar Alimento</button>
                <div class="right-actions">
                    <button class="btn btn-secondary" onclick="openEditModalFromDetail()">Editar Alimento</button>
                    <button class="btn btn-primary" onclick="closeModal('foodDetailModal')">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="foodEditModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeModal('foodEditModal')">&times;</button>
            <h2>Editar Alimento: <span id="editFoodNameHeader"></span></h2>
            <p style="text-align: right; color: var(--light-text-color); margin-top: -15px;">Valores por <span id="editUnitLabel"></span></p>

            <form id="editFoodForm">
                <input type="hidden" id="editFoodIndex">

                <div class="form-group">
                    <label for="editName">Nombre del Alimento:</label>
                    <input type="text" id="editName" required>
                    <span class="validation-message"></span>
                </div>
                
                <div class="form-group">
                    <label for="editCategory">Categoría:</label>
                    <select id="editCategory" required>
                        </select>
                    <span class="validation-message"></span>
                </div>

                <div class="form-group">
                    <label for="editUnitBase">Unidad Base (para 100g/ml):</label>
                    <select id="editUnitBase" required onchange="updatePriceInput(this.value)">
                        <option value="g">Gramo (g)</option>
                        <option value="ml">Mililitro (ml)</option>
                    </select>
                    <span class="validation-message"></span>
                </div>

                <div class="form-group">
                    <label for="editPrice">Precio por <span id="priceUnitLabel">kg</span>:</label>
                    <input type="number" id="editPrice" step="0.01" min="0" required>
                    <span class="validation-message"></span>
                </div>

                <p class="section-title">Características Especiales:</p>
                <div class="form-group checkbox-group" id="editCharacteristics">
                    </div>

                <p class="section-title">Macronutrientes:</p>
                <div class="form-group">
                    <label for="editCalories">Calorías (Kcal):</label>
                    <input type="number" id="editCalories" step="0.1" min="0" required readonly> 
                    <span class="validation-message"></span>
                </div>
                <div class="form-group">
                    <label for="editProtein">Proteínas (g):</label>
                    <input type="number" id="editProtein" step="0.1" min="0" required oninput="calculateAndDisplayCalories(); validateMacronutrients()">
                    <span class="validation-message"></span>
                </div>
                <div class="form-group">
                    <label for="editCarbs">Carbohidratos (g):</label>
                    <input type="number" id="editCarbs" step="0.1" min="0" required oninput="calculateAndDisplayCalories(); validateMacronutrients()">
                    <span class="validation-message"></span>
                </div>
                <div class="form-group">
                    <label for="editSugars">de los cuales Azúcares (g):</label>
                    <input type="number" id="editSugars" step="0.1" min="0" oninput="validateMacronutrients()">
                    <span class="validation-message"></span>
                </div>
                <div class="form-group">
                    <label for="editFat">Grasas (g):</label>
                    <input type="number" id="editFat" step="0.1" min="0" required oninput="calculateAndDisplayCalories(); validateMacronutrients()">
                    <span class="validation-message"></span>
                </div>
                <div class="form-group">
                    <label for="editSaturatedFat">de las cuales Grasas Saturadas (g):</label>
                    <input type="number" id="editSaturatedFat" step="0.1" min="0" oninput="validateMacronutrients()">
                    <span class="validation-message"></span>
                </div>
                <div class="form-group">
                    <label for="editFiber">Fibra (g):</label>
                    <input type="number" id="editFiber" step="0.1" min="0" oninput="calculateAndDisplayCalories()">
                    <span class="validation-message"></span>
                </div>
                <div class="form-group">
                    <label for="editSalt">Sal (g):</label>
                    <input type="number" id="editSalt" step="0.01" min="0">
                    <span class="validation-message"></span>
                </div>

                <p class="section-title">Vitaminas y Minerales:</p>
                <div class="micronutrient-inputs">
                    <table id="editMicronutrientTable">
                        <thead>
                            <tr>
                                <th>Nutriente</th>
                                <th>Cantidad y Unidad</th>
                                <th></th> </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
                <button type="button" class="add-micronutrient-btn" onclick="addMicronutrientField()">+ Añadir Vitamina/Mineral</button>

                <div class="modal-actions">
                    <button class="btn btn-danger" id="deleteFoodBtn" style="display: none;" onclick="confirmDeleteFood()">Eliminar Alimento</button>
                    <div class="right-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('foodEditModal')">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="confirmationModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <h2>Confirmar Acción</h2>
            <p id="confirmationMessage"></p>
            <div class="modal-actions" style="justify-content: center;">
                <button class="btn btn-secondary" onclick="closeModal('confirmationModal')">Cancelar</button>
                <button class="btn btn-danger" id="confirmActionButton">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="toastNotification" class="toast-notification"></div>

    <script>
        // L_E_O: Almacenamiento de Datos y Configuración Inicial
        // Array principal que contendrá todos los datos de los alimentos.
        // Ahora se inicializa vacío y se cargará desde el JSON.
        let foodData = [];

        // L_E_O: Categorías de alimentos para filtrado y clasificación.
        const foodCategories = [
            "Frutas",
            "Verduras y Hortalizas",
            "Carnes y Proteínas",
            "Lácteos y Alternativas",
            "Pan, Cereales y Legumbres",
            "Frutos Secos y Semillas",
            "Grasas Saludables",
            "Bebidas",
            "Otros"
        ];

        // L_E_O: Características especiales para filtrado y etiquetado.
        const specialCharacteristics = [
            "Apto Vegano", "Apto Celíaco", "Bajo en Sal", "Sin Lactosa", "Alto en Fibra",
            "Bajo en Grasa", "Rico en Omega-3", "Fuente de Calcio", "Probiótico",
            "Sin Glúten", "Alto en Proteínas", "Alto en Vitamina C", "Alto en Hierro",
            "Rico en Vitamina E", "Alto en Vitamina K", "Bajo en Azúcares", "Sin Calorías",
            "Fuente de Vitamina D"
        ];

        // L_E_O: Lista predefinida de micronutrientes disponibles para añadir.
        // Incluye Vitamina K1 y K2 separadas.
        const availableMicronutrients = [
            { name: "Vitamina A", unit: "mcg", type: "Vitamina" }, { name: "Vitamina B1", unit: "mg", type: "Vitamina" },
            { name: "Vitamina B2", unit: "mg", type: "Vitamina" }, { name: "Vitamina B3", unit: "mg", type: "Vitamina" },
            { name: "Vitamina B5", unit: "mg", type: "Vitamina" }, { name: "Vitamina B6", unit: "mg", type: "Vitamina" },
            { name: "Vitamina B9 (Folato)", unit: "mcg", type: "Vitamina" }, { name: "Vitamina B12", unit: "mcg", type: "Vitamina" },
            { name: "Vitamina C", unit: "mg", type: "Vitamina" }, { name: "Vitamina D", unit: "mcg", type: "Vitamina" },
            { name: "Vitamina E", unit: "mg", type: "Vitamina" },
            { name: "Vitamina K1", unit: "mcg", type: "Vitamina" },
            { name: "Vitamina K2", unit: "mcg", type: "Vitamina" },
            { name: "Biotina", unit: "mcg", type: "Vitamina" }, { name: "Colina", unit: "mg", type: "Vitamina" },

            { name: "Calcio", unit: "mg", type: "Mineral" }, { name: "Cloro", unit: "mg", type: "Mineral" },
            { name: "Cobre", unit: "mg", type: "Mineral" }, { name: "Cromo", unit: "mcg", type: "Mineral" },
            { name: "Fósforo", unit: "mg", type: "Mineral" }, { name: "Hierro", unit: "mg", type: "Mineral" },
            { name: "Magnesio", unit: "mg", type: "Mineral" }, { name: "Manganeso", unit: "mg", type: "Mineral" },
            { name: "Molibdeno", unit: "mcg", type: "Mineral" }, { name: "Potasio", unit: "mg", type: "Mineral" },
            { name: "Selenio", unit: "mcg", type: "Mineral" }, { name: "Sodio", unit: "g", type: "Mineral" },
            { name: "Yodo", unit: "mcg", type: "Mineral" }, { name: "Zinc", unit: "mg", type: "Mineral" },

            { name: "Omega-3", unit: "g", type: "Otros" }, { name: "Omega-6", unit: "g", type: "Otros" },
            { name: "Omega-9 (Ácido Oleico)", unit: "g", type: "Otros" }
        ];

        // L_E_O: Valores Diarios Recomendados (VDR) - EJEMPLO.
        // Estos valores son cruciales para el cálculo de los porcentajes de VDR.
        // Se ha añadido Vitamina K1 y K2.
        const dailyRecommendedValues = {
            "calories": 2000, "fat": 70, "saturatedFat": 20, "carbs": 275, "sugars": 50, "protein": 50, "fiber": 30, "salt": 6,
            "Vitamina A": { value: 800, unit: "mcg" }, "Vitamina C": { value: 80, unit: "mg" }, "Vitamina D": { value: 5, unit: "mcg" },
            "Vitamina E": { value: 12, unit: "mg" }, "Vitamina K1": { value: 75, unit: "mcg" }, "Vitamina K2": { value: 45, unit: "mcg" },
            "Vitamina B1": { value: 1.1, unit: "mg" }, "Vitamina B2": { value: 1.4, unit: "mg" }, "Vitamina B3": { value: 16, unit: "mg" },
            "Vitamina B5": { value: 6, unit: "mg" }, "Vitamina B6": { value: 1.4, unit: "mg" }, "Vitamina B9 (Folato)": { value: 200, unit: "mcg" }, "Vitamina B12": { value: 2.5, unit: "mcg" },
            "Biotina": { value: 50, unit: "mcg" }, "Colina": { value: 550, unit: "mg" },
            "Calcio": { value: 800, unit: "mg" }, "Cloro": { value: 800, unit: "mg" }, "Cobre": { value: 1, unit: "mg" },
            "Cromo": { value: 40, unit: "mcg" }, "Fósforo": { value: 700, unit: "mg" }, "Hierro": { value: 14, unit: "mg" },
            "Magnesio": { value: 375, unit: "mg" }, "Manganeso": { value: 2, unit: "mg" }, "Molibdeno": { value: 50, unit: "mcg" },
            "Potasio": { value: 2000, unit: "mg" }, "Selenio": { value: 55, unit: "mcg" }, "Sodio": { value: 2.4, unit: "g" },
            "Yodo": { value: 150, unit: "mcg" }, "Zinc": { value: 10, unit: "mg" },
            "Omega-3": { value: 250, unit: "mg" }, "Omega-6": { value: 10, unit: "g" }, "Omega-9 (Ácido Oleico)": { value: 20, unit: "g" }
        };

        // Referencias a elementos DOM para una manipulación más eficiente.
        const foodListDiv = document.getElementById('foodList');
        const foodDetailModal = document.getElementById('foodDetailModal');
        const foodEditModal = document.getElementById('foodEditModal');
        const confirmationModal = document.getElementById('confirmationModal');
        const detailNutrientTableBody = document.getElementById('detailNutrientTableBody');
        const editMicronutrientTableBody = document.getElementById('editMicronutrientTable').getElementsByTagName('tbody')[0];
        const editUnitBaseSelect = document.getElementById('editUnitBase');
        const priceUnitLabel = document.getElementById('priceUnitLabel');
        const editPriceInput = document.getElementById('editPrice');
        const searchInput = document.getElementById('searchFood');
        const sortCriteriaSelect = document.getElementById('sortCriteria');
        const sortDirectionSelect = document.getElementById('sortDirection');
        const micronutrientSortContainer = document.getElementById('micronutrientSortContainer');
        const sortMicronutrientSelect = document.getElementById('sortMicronutrient');
        const editCaloriesInput = document.getElementById('editCalories');
        const editProteinInput = document.getElementById('editProtein');
        const editCarbsInput = document.getElementById('editCarbs');
        const editFatInput = document.getElementById('editFat');
        const editFiberInput = document.getElementById('editFiber');
        const editSugarsInput = document.getElementById('editSugars');
        const editSaturatedFatInput = document.getElementById('editSaturatedFat');
        const editSaltInput = document.getElementById('editSalt');
        const deleteFoodBtn = document.getElementById('deleteFoodBtn');
        const confirmationMessage = document.getElementById('confirmationMessage');
        const confirmActionButton = document.getElementById('confirmActionButton');

        // Elementos para filtros avanzados
        const advancedFilterContainer = document.getElementById('advancedFilterContainer');
        const filterCaloriesMin = document.getElementById('filterCaloriesMin');
        const filterCaloriesMax = document.getElementById('filterCaloriesMax');
        const filterProteinMin = document.getElementById('filterProteinMin');
        const filterFatMax = document.getElementById('filterFatMax');
        const filterCarbsMin = document.getElementById('filterCarbsMin');
        const filterFiberMin = document.getElementById('filterFiberMin');
        const filterSugarMax = document.getElementById('filterSugarMax');
        const filterSaltMax = document.getElementById('filterSaltMax');
        const filterPriceMax = document.getElementById('filterPriceMax');
        const filterCategorySelect = document.getElementById('filterCategory');
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        const detailQuantitySelector = document.getElementById('detailQuantitySelector');
        const detailCustomQuantityInput = document.getElementById('detailCustomQuantity');
        const filterSpecialCharacteristicsDiv = document.getElementById('filterSpecialCharacteristics');


        let currentEditingFoodIndex = -1; // Almacena el índice del alimento que se está editando o añadiendo.
        let displayedFoodCount = 100; // L_E_O: Cantidad de alimentos a mostrar inicialmente.
        const ITEMS_PER_LOAD = 100; // L_E_O: Cantidad de alimentos a cargar con el botón "Cargar Más".

        /**
         * Muestra una notificación "toast" en la parte inferior de la pantalla.
         * @param {string} message - El texto del mensaje a mostrar.
         */
        function showToast(message) {
            const toast = document.getElementById("toastNotification");
            toast.textContent = message;
            toast.className = "toast-notification show"; // Añade la clase 'show' para activar la animación.
            setTimeout(function(){
                toast.className = toast.className.replace("show", ""); // Elimina la clase 'show' después de un tiempo.
            }, 3000); // El toast desaparece después de 3 segundos.
        }

        /**
         * Calcula el porcentaje del Valor Diario Recomendado (VDR) para un nutriente dado.
         * Realiza conversiones de unidades básicas (mcg/mg/g) si es necesario.
         * @param {number} nutrientValue - La cantidad del nutriente en el alimento.
         * @param {string} nutrientName - El nombre del nutriente (debe coincidir con las claves en dailyRecommendedValues).
         * @param {string} unit - La unidad de la cantidad del nutriente (ej. "mg", "mcg", "g").
         * @returns {string} - El porcentaje de VDR como cadena (ej. "80") o '-' si no hay VDR definido.
         */
        function calculateVDR(nutrientValue, nutrientName, unit) {
            let vdrTarget = dailyRecommendedValues[nutrientName];
            if (!vdrTarget) return '-'; // No hay VDR definido para este nutriente.

            // Obtiene el valor y la unidad del VDR objetivo.
            let vdrValue = typeof vdrTarget === 'object' ? vdrTarget.value : vdrTarget;
            let vdrUnit = typeof vdrTarget === 'object' ? vdrTarget.unit : unit; // Asume la misma unidad si no se especifica.

            // L_E_O: Conversiones de unidades básicas para cálculo de VDR
            // Esto asegura que el valor del nutriente y el VDR estén en la misma unidad antes de calcular el porcentaje.
            if (unit === "mcg" && vdrUnit === "mg") {
                vdrValue /= 1000;
            } else if (unit === "mg" && vdrUnit === "mcg") {
                vdrValue *= 1000;
            } else if (unit === "mg" && vdrUnit === "g") {
                vdrValue /= 1000;
            } else if (unit === "g" && vdrUnit === "mg") {
                vdrValue *= 1000;
            } else if (unit === "g" && vdrUnit === "mcg") {
                vdrValue /= 1000000;
            } else if (unit === "mcg" && vdrUnit === "g") {
                vdrValue *= 1000000;
            }

            if (vdrValue && vdrValue > 0) {
                // Calcula y redondea el porcentaje de VDR.
                return ((nutrientValue / vdrValue) * 100).toFixed(0);
            }
            return '-'; // Si el VDR es cero o no válido.
        }

        /**
         * Calcula las calorías de un alimento basándose en sus macronutrientes.
         * Utiliza las proporciones estándar: 4 Kcal/g para proteínas y carbohidratos, 9 Kcal/g para grasas.
         * @returns {number} - Las calorías calculadas, redondeadas a un decimal.
         */
        function calculateCalories() {
            const protein = parseFloat(editProteinInput.value) || 0;
            const carbs = parseFloat(editCarbsInput.value) || 0;
            const fat = parseFloat(editFatInput.value) || 0;
            // La fibra se considera 0 kcal/g en este cálculo simple.
            const calculatedCalories = (protein * 4) + (carbs * 4) + (fat * 9);
            return calculatedCalories.toFixed(1); // Mantiene un decimal.
        }

        /**
         * Calcula y muestra las calorías en el campo de calorías del modal de edición.
         */
        function calculateAndDisplayCalories() {
            editCaloriesInput.value = calculateCalories();
        }

        /**
         * Valida que los valores de los macronutrientes sean coherentes y positivos.
         * - Los azúcares no pueden ser mayores que los carbohidratos totales.
         * - Las grasas saturadas no pueden ser mayores que las grasas totales.
         * - Todos los campos numéricos deben ser números no negativos.
         * Muestra mensajes de validación al usuario.
         * @returns {boolean} - True si todos los macronutrientes son válidos, false en caso contrario.
         */
        function validateMacronutrients() {
            const carbs = parseFloat(editCarbsInput.value) || 0;
            const sugars = parseFloat(editSugarsInput.value) || 0;
            const fat = parseFloat(editFatInput.value) || 0;
            const saturatedFat = parseFloat(editSaturatedFatInput.value) || 0;
            const salt = parseFloat(editSaltInput.value) || 0;

            let isValid = true;

            // Validación: Azúcares vs. Carbohidratos
            if (sugars > carbs) {
                editSugarsInput.classList.add('invalid');
                editSugarsInput.nextElementSibling.textContent = 'Los azúcares no pueden ser mayores que los carbohidratos.';
                editSugarsInput.nextElementSibling.style.display = 'block';
                isValid = false;
            } else {
                editSugarsInput.classList.remove('invalid');
                editSugarsInput.nextElementSibling.style.display = 'none';
            }

            // Validación: Grasas Saturadas vs. Grasas Totales
            if (saturatedFat > fat) {
                editSaturatedFatInput.classList.add('invalid');
                editSaturatedFatInput.nextElementSibling.textContent = 'Las grasas saturadas no pueden ser mayores que las grasas totales.';
                editSaturatedFatInput.nextElementSibling.style.display = 'block';
                isValid = false;
            } else {
                editSaturatedFatInput.classList.remove('invalid');
                editSaturatedFatInput.nextElementSibling.style.display = 'none';
            }

            // Validación: Sal (asegura que no sea negativa, aunque no tiene límite superior estricto aquí)
            if (salt < 0) {
                 editSaltInput.classList.add('invalid');
                editSaltInput.nextElementSibling.textContent = 'La sal no puede ser negativa.';
                editSaltInput.nextElementSibling.style.display = 'block';
                isValid = false;
            } else {
                 editSaltInput.classList.remove('invalid');
                editSaltInput.nextElementSibling.style.display = 'none';
            }

            // Validación general para campos numéricos: deben ser no negativos.
            const numericFields = [
                editProteinInput, editCarbsInput, editFatInput, editFiberInput, editPriceInput
            ];
            numericFields.forEach(input => {
                const val = parseFloat(input.value);
                if (isNaN(val) || val < 0) {
                    input.classList.add('invalid');
                    input.nextElementSibling.textContent = 'Debe ser un número positivo.';
                    input.nextElementSibling.style.display = 'block';
                    isValid = false;
                } else {
                    input.classList.remove('invalid');
                    input.nextElementSibling.style.display = 'none';
                }
            });

            return isValid;
        }

        /**
         * Renderiza las tarjetas de alimentos en la interfaz principal.
         * Aplica paginación: solo muestra un número limitado de alimentos y un botón "Cargar Más" si hay más.
         * @param {Array<Object>} filteredAndSortedData - Los datos de alimentos ya filtrados y ordenados.
         */
        function renderFoodCards(filteredAndSortedData) {
            foodListDiv.innerHTML = ''; // Limpia las tarjetas existentes.
            // Limita la cantidad de alimentos a mostrar según `displayedFoodCount`.
            const foodsToDisplay = filteredAndSortedData.slice(0, displayedFoodCount);

            foodsToDisplay.forEach((food) => {
                // Determina la unidad de visualización (g o ml) para 100 unidades.
                const displayUnit = food.unitBase === 'g' ? 'g' : 'ml';
                // Determina la unidad de precio (kg o L).
                const priceUnitDisplay = food.unitBase === 'g' ? 'kg' : 'L';

                // Prepara los micronutrientes para mostrar, incluyendo su VDR.
                const allMicrosWithVDR = [];
                for (const [name, data] of Object.entries(food.micronutrients)) {
                    const vdr = calculateVDR(data.value, name, data.unit);
                    if (vdr !== '-') {
                        allMicrosWithVDR.push({ name, value: data.value, unit: data.unit, type: data.type, vdr: parseFloat(vdr) });
                    }
                }

                // Selecciona los 3 micronutrientes principales de cada tipo (Vitamina, Mineral, Otros) por VDR descendente.
                const vitamins = allMicrosWithVDR.filter(m => m.type === 'Vitamina').sort((a, b) => b.vdr - a.vdr).slice(0, 3);
                const minerals = allMicrosWithVDR.filter(m => m.type === 'Mineral').sort((a, b) => b.vdr - a.vdr).slice(0, 3);
                const others = allMicrosWithVDR.filter(m => m.type === 'Otros').sort((a, b) => b.vdr - a.vdr).slice(0, 3);

                let micronutrientsHtml = '';
                // Construye el HTML para las vitaminas.
                if (vitamins.length > 0) {
                    micronutrientsHtml += '<strong>Vitaminas:</strong><ul>';
                    vitamins.forEach(micro => {
                        micronutrientsHtml += `<li>${micro.name}: ${micro.value}${micro.unit} (${micro.vdr}%)</li>`;
                    });
                    micronutrientsHtml += '</ul>';
                }
                // Construye el HTML para los minerales.
                if (minerals.length > 0) {
                    micronutrientsHtml += '<strong>Minerales:</strong><ul>';
                    minerals.forEach(micro => {
                        micronutrientsHtml += `<li>${micro.name}: ${micro.value}${micro.unit} (${micro.vdr}%)</li>`;
                    });
                    micronutrientsHtml += '</ul>';
                }
                // Construye el HTML para otros micronutrientes.
                if (others.length > 0) {
                    micronutrientsHtml += '<strong>Otros:</strong><ul>';
                    others.forEach(micro => {
                        micronutrientsHtml += `<li>${micro.name}: ${micro.value}${micro.unit}</li>`; // Otros quizás no tienen VDR.
                    });
                    micronutrientsHtml += '</ul>';
                }

                if (micronutrientsHtml === '') {
                    micronutrientsHtml = '<p>No disponibles</p>';
                }

                // Genera el HTML completo para una tarjeta de alimento.
                const cardHtml = `
                    <div class="food-card" data-index="${foodData.indexOf(food)}" onclick="openDetailModal(${foodData.indexOf(food)})">
                        <h3>${food.name}</h3>
                        <div class="food-card-content">
                            <div class="left-column">
                                <p style="font-size: 0.8em; color: var(--light-text-color);">Por 100${displayUnit}</p>
                                <div class="nutrition-summary">
                                    <p><strong>Calorías:</strong> ${food.calories} Kcal</p>
                                    <p><strong>Proteínas:</strong> ${food.protein}g</p>
                                    <p><strong>Carbohidratos:</strong> ${food.carbs}g</p>
                                    <p class="sub-nutrient">de los cuales azúcares: ${food.sugars}g</p>
                                    <p><strong>Grasas:</strong> ${food.fat}g</p>
                                    <p class="sub-nutrient">de las cuales saturadas: ${food.saturatedFat}g</p>
                                    <p><strong>Fibra:</strong> ${food.fiber}g</p>
                                    <p><strong>Sal:</strong> ${food.salt}g</p>
                                </div>
                            </div>
                            <div class="right-column">
                                <div class="micronutrients-brief">
                                    ${micronutrientsHtml}
                                </div>
                                <p class="price">Precio: ${food.price.toFixed(2)} €/${priceUnitDisplay}</p>
                            </div>
                        </div>
                    </div>
                `;
                foodListDiv.insertAdjacentHTML('beforeend', cardHtml); // Inserta la tarjeta en el DOM.
            });

            // L_E_O: Lógica para mostrar/ocultar el botón "Cargar Más".
            if (filteredAndSortedData.length > displayedFoodCount) {
                loadMoreBtn.style.display = 'block';
            } else {
                loadMoreBtn.style.display = 'none';
            }
        }

        /**
         * Incrementa la cantidad de alimentos a mostrar y vuelve a renderizar la lista.
         * Se activa al hacer clic en el botón "Cargar Más".
         */
        function loadMoreFoods() {
            displayedFoodCount += ITEMS_PER_LOAD; // Aumenta el contador de alimentos a mostrar.
            filterAndSortFoods(); // Vuelve a renderizar con la nueva cantidad.
        }

        /**
         * Abre un modal específico.
         * @param {string} modalId - El ID del modal a abrir.
         */
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active'); // Añade la clase 'active' para mostrar el modal.
        }

        /**
         * Cierra un modal específico.
         * @param {string} modalId - El ID del modal a cerrar.
         */
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active'); // Elimina la clase 'active' para ocultar el modal.
        }

        /**
         * Genera el HTML para una barra de progreso de VDR, con colores que indican el nivel.
         * @param {string} vdrPercent - El porcentaje de VDR como cadena (ej. "80").
         * @returns {string} - El HTML de la celda de la tabla con la barra de progreso.
         */
        function getVdrProgressBarHtml(vdrPercent) {
            if (vdrPercent === '-') {
                return `<div class="vdr-cell"><span class="vdr-text">-</span></div>`; // No hay VDR, no se muestra barra.
            }
            
            const percentValue = parseFloat(vdrPercent);
            let fillClass = '';
            // Asigna una clase CSS basada en el porcentaje para colorear la barra.
            if (percentValue < 25) {
                fillClass = 'low';
            } else if (percentValue >= 25 && percentValue < 75) {
                fillClass = 'medium';
            } else if (percentValue >= 75 && percentValue <= 100) {
                fillClass = 'high';
            } else { // Más del 100%
                fillClass = 'excess';
            }

            // Limita el ancho de la barra al 100% para visualización.
            const fillWidth = Math.min(percentValue, 100);

            return `
                <div class="vdr-cell">
                    <span class="vdr-text">${vdrPercent}%</span>
                    <div class="vdr-progress-bar">
                        <div class="vdr-progress-fill ${fillClass}" style="width: ${fillWidth}%;"></div>
                    </div>
                </div>
            `;
        }

        /**
         * Abre el modal de detalle para un alimento específico.
         * @param {number} index - El índice del alimento en el array `foodData`.
         */
        function openDetailModal(index) {
            const food = foodData[index];
            if (!food) return; // Si el alimento no existe, no hace nada.

            currentEditingFoodIndex = index; // Guarda el índice del alimento actual.

            document.getElementById('detailFoodName').textContent = food.name;
            document.getElementById('detailCategory').textContent = food.category || 'No especificada';
            document.getElementById('detailCharacteristics').textContent = food.characteristics && food.characteristics.length > 0 ? food.characteristics.join(', ') : 'Ninguna';

            // Resetea el selector de cantidad y el input personalizado en el modal de detalle.
            detailQuantitySelector.value = "100";
            detailCustomQuantityInput.value = "100";
            detailCustomQuantityInput.style.display = 'none';

            updateDetailNutrients(food); // Actualiza los nutrientes para la cantidad por defecto (100g/ml).
            
            // Muestra el botón de eliminar en el modal de detalle.
            document.getElementById('deleteFoodBtn').style.display = 'block';

            openModal('foodDetailModal');
        }

        /**
         * Actualiza la tabla de nutrientes en el modal de detalle basándose en la cantidad seleccionada.
         * @param {Object} [foodItem=null] - El objeto alimento. Si es nulo, usa `foodData[currentEditingFoodIndex]`.
         */
        function updateDetailNutrients(foodItem = null) {
            const food = foodItem || foodData[currentEditingFoodIndex];
            if (!food) return;

            let quantityFactor = 1;
            const selectedOption = detailQuantitySelector.value;

            // Calcula el factor de escala basado en la cantidad seleccionada o personalizada.
            if (selectedOption === "user") {
                detailCustomQuantityInput.style.display = 'inline-block';
                const customQty = parseFloat(detailCustomQuantityInput.value);
                if (!isNaN(customQty) && customQty > 0) {
                    quantityFactor = customQty / 100;
                } else {
                    quantityFactor = 1; // Por defecto a 100 si la entrada personalizada es inválida.
                }
            } else {
                detailCustomQuantityInput.style.display = 'none';
                quantityFactor = parseFloat(selectedOption) / 100;
            }

            // Actualiza la etiqueta de la unidad de detalle (ej. "Valores por 100g").
            const detailDisplayUnit = `${(100 * quantityFactor)} ${food.unitBase}`;
            document.getElementById('detailUnitLabel').textContent = detailDisplayUnit;
            
            detailNutrientTableBody.innerHTML = ''; // Limpia el contenido de la tabla de nutrientes.

            // Define las filas de macronutrientes a mostrar.
            const macroRows = [
                { name: "Calorías", value: food.calories, unit: "Kcal", vdrKey: "calories" },
                { name: "Grasas", value: food.fat, unit: "g", vdrKey: "fat" },
                { name: "de las cuales saturadas", value: food.saturatedFat, unit: "g", vdrKey: "saturatedFat", isSub: true },
                { name: "Carbohidratos", value: food.carbs, unit: "g", vdrKey: "carbs" },
                { name: "de los cuales azúcares", value: food.sugars, unit: "g", vdrKey: "sugars", isSub: true },
                { name: "Fibra", value: food.fiber, unit: "g", vdrKey: "fiber" },
                { name: "Proteínas", value: food.protein, unit: "g", vdrKey: "protein" },
                { name: "Sal", value: food.salt, unit: "g", vdrKey: "salt" }
            ];

            // Añade las filas de macronutrientes a la tabla.
            macroRows.forEach(nutrient => {
                const row = document.createElement('tr');
                row.className = nutrient.isSub ? 'sub-nutrient-row' : ''; // Clase para sangría de sub-nutrientes.
                const scaledValue = (nutrient.value * quantityFactor).toFixed(nutrient.unit === 'g' ? 1 : 0);
                const vdrPercent = calculateVDR(nutrient.value * quantityFactor, nutrient.vdrKey, nutrient.unit);
                row.innerHTML = `
                    <td>${nutrient.name}</td>
                    <td>${scaledValue}${nutrient.unit}</td>
                    <td>${getVdrProgressBarHtml(vdrPercent)}</td>
                `;
                detailNutrientTableBody.appendChild(row);
            });

            // Clasifica los micronutrientes por tipo.
            const vitamins = [];
            const minerals = [];
            const others = [];

            for (const [name, data] of Object.entries(food.micronutrients)) {
                if (data.type === "Vitamina") {
                    vitamins.push({ name, ...data });
                } else if (data.type === "Mineral") {
                    minerals.push({ name, ...data });
                } else {
                    others.push({ name, ...data });
                }
            }

            // Ordena los micronutrientes alfabéticamente por nombre.
            vitamins.sort((a, b) => a.name.localeCompare(b.name));
            minerals.sort((a, b) => a.name.localeCompare(b.name));
            others.sort((a, b) => a.name.localeCompare(b.name));

            /**
             * Función auxiliar para añadir una sección de micronutrientes a la tabla de detalle.
             * @param {string} title - Título de la sección (ej. "Vitaminas").
             * @param {Array<Object>} nutrientsArray - Array de objetos de nutrientes para esa sección.
             */
            const appendMicronutrientSection = (title, nutrientsArray) => {
                if (nutrientsArray.length > 0) {
                    const sectionHeaderRow = document.createElement('tr');
                    sectionHeaderRow.className = 'section-divider';
                    sectionHeaderRow.innerHTML = `<td colspan="3">${title}:</td>`;
                    detailNutrientTableBody.appendChild(sectionHeaderRow);

                    nutrientsArray.forEach(nutrient => {
                        const row = document.createElement('tr');
                        const scaledValue = (nutrient.value * quantityFactor).toFixed(nutrient.unit === 'g' ? 2 : 1);
                        const vdrPercent = calculateVDR(nutrient.value * quantityFactor, nutrient.name, nutrient.unit);
                        row.innerHTML = `
                            <td class="micronutrient-name">${nutrient.name}</td>
                            <td>${scaledValue}${nutrient.unit}</td>
                            <td>${getVdrProgressBarHtml(vdrPercent)}</td>
                        `;
                        detailNutrientTableBody.appendChild(row);
                    });
                }
            };

            // Añade las secciones de micronutrientes.
            appendMicronutrientSection('Vitaminas', vitamins);
            appendMicronutrientSection('Minerales', minerals);
            appendMicronutrientSection('Otros Componentes', others);

            // Mensaje si no hay vitaminas o minerales añadidas.
            if (vitamins.length === 0 && minerals.length === 0 && others.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="3" style="text-align: center; color: var(--light-text-color);">No se han añadido vitaminas o minerales para este alimento.</td>`;
                detailNutrientTableBody.appendChild(row);
            }
        }

        /**
         * Abre el modal de edición para un alimento existente o para crear uno nuevo.
         * @param {number} index - El índice del alimento en `foodData` o -1 para un nuevo alimento.
         */
        function openEditModal(index) {
            currentEditingFoodIndex = index;
            const isNewFood = index === -1; // Bandera para saber si es un nuevo alimento.
            const food = isNewFood ? {} : foodData[index]; // Obtiene el alimento o un objeto vacío para uno nuevo.

            document.getElementById('editFoodNameHeader').textContent = isNewFood ? 'Nuevo Alimento' : food.name;
            document.getElementById('editFoodIndex').value = index;

            // Muestra u oculta el botón de eliminar según si es un alimento nuevo o existente.
            deleteFoodBtn.style.display = isNewFood ? 'none' : 'block';

            // L_E_O: Rellena el selector de categorías.
            const editCategorySelect = document.getElementById('editCategory');
            editCategorySelect.innerHTML = '<option value="">Selecciona una categoría</option>';
            foodCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                if (food.category === cat) option.selected = true; // Selecciona la categoría actual del alimento.
                editCategorySelect.appendChild(option);
            });
            // Asegura que para un nuevo alimento o categoría no definida, la opción por defecto esté seleccionada.
            if (isNewFood || !food.category) {
                editCategorySelect.value = "";
            }

            // L_E_O: Rellena los checkboxes de características especiales.
            const editCharacteristicsDiv = document.getElementById('editCharacteristics');
            editCharacteristicsDiv.innerHTML = '';
            specialCharacteristics.forEach(char => {
                const id = `editChar_${char.replace(/\s+/g, '')}`; // ID único para cada checkbox.
                const isChecked = isNewFood ? false : (food.characteristics && food.characteristics.includes(char));
                editCharacteristicsDiv.innerHTML += `
                    <label for="${id}">
                        <input type="checkbox" id="${id}" value="${char}" ${isChecked ? 'checked' : ''}>
                        ${char}
                    </label>
                `;
            });

            // Actualiza la etiqueta de la unidad base en el modal de edición.
            const editDisplayUnit = `100${isNewFood ? 'g' : food.unitBase}`;
            document.getElementById('editUnitLabel').textContent = editDisplayUnit;
            
            // Establece la unidad base y actualiza la etiqueta del precio.
            editUnitBaseSelect.value = isNewFood ? 'g' : food.unitBase;
            updatePriceInput(editUnitBaseSelect.value);

            // Rellena los campos de macronutrientes y precio.
            editPriceInput.value = isNewFood ? '' : food.price;
            document.getElementById('editName').value = isNewFood ? '' : food.name;
            document.getElementById('editProtein').value = isNewFood ? '' : food.protein;
            document.getElementById('editCarbs').value = isNewFood ? '' : food.carbs;
            document.getElementById('editSugars').value = isNewFood ? '' : food.sugars;
            document.getElementById('editFat').value = isNewFood ? '' : food.fat;
            document.getElementById('editSaturatedFat').value = isNewFood ? '' : food.saturatedFat;
            document.getElementById('editFiber').value = isNewFood ? '' : food.fiber;
            document.getElementById('editSalt').value = isNewFood ? '' : food.salt;

            calculateAndDisplayCalories(); // Calcula y muestra las calorías iniciales.
            
            editMicronutrientTableBody.innerHTML = ''; // Limpia los campos de micronutrientes existentes.
            // Ordena y añade los campos de micronutrientes si el alimento ya existe.
            const sortedMicros = isNewFood ? [] : Object.entries(food.micronutrients).sort((a, b) => a[0].localeCompare(b[0]));
            sortedMicros.forEach(([name, data]) => {
                addMicronutrientField(name, data.value, data.unit, data.type);
            });
            
            // Si no hay micronutrientes, añade un campo vacío para empezar (si hay micronutrientes disponibles en la lista maestra).
            if (sortedMicros.length === 0 && availableMicronutrients.length > 0) {
                addMicronutrientField();
            }

            // Limpia los mensajes de validación al abrir el modal.
            document.querySelectorAll('.validation-message').forEach(span => span.style.display = 'none');
            document.querySelectorAll('.form-group input, .form-group select').forEach(input => input.classList.remove('invalid'));

            openModal('foodEditModal');
        }

        /**
         * Cierra el modal de detalle y abre el modal de edición para el alimento actualmente seleccionado.
         */
        function openEditModalFromDetail() {
            closeModal('foodDetailModal');
            openEditModal(currentEditingFoodIndex);
        }

        /**
         * Actualiza la etiqueta de la unidad de precio (kg o L) según la unidad base seleccionada.
         * @param {string} unitBase - La unidad base seleccionada ("g" o "ml").
         */
        function updatePriceInput(unitBase) {
            if (unitBase === 'g') {
                priceUnitLabel.textContent = 'kg';
            } else {
                priceUnitLabel.textContent = 'L';
            }
        }

        /**
         * Añade una nueva fila para un campo de micronutriente en el modal de edición.
         * @param {string} [currentName=''] - Nombre del micronutriente a precargar.
         * @param {number} [currentValue=''] - Valor del micronutriente a precargar.
         * @param {string} [currentUnit=''] - Unidad del micronutriente a precargar.
         * @param {string} [currentType=''] - Tipo del micronutriente (Vitamina/Mineral/Otros) a precargar.
         */
        function addMicronutrientField(currentName = '', currentValue = '', currentUnit = '', currentType = '') {
            const row = document.createElement('tr');
            row.className = 'micronutrient-input-row';

            // Crea un conjunto de nombres de micronutrientes ya seleccionados para deshabilitar opciones duplicadas.
            const currentlySelectedNames = new Set(
                Array.from(editMicronutrientTableBody.querySelectorAll('.micronutrient-name-select'))
                    .map(select => select.value)
                    .filter(name => name !== '' && name !== currentName) // Excluye el nutriente actual si se está precargando.
            );

            let optionsHtml = '<option value="">Selecciona un nutriente</option>';
            // Ordena los micronutrientes disponibles alfabéticamente.
            const sortedAvailableMicros = [...availableMicronutrients].sort((a, b) => a.name.localeCompare(b.name));

            // Genera las opciones para el selector de nombre del micronutriente.
            sortedAvailableMicros.forEach(micro => {
                const isDisabled = currentlySelectedNames.has(micro.name); // Deshabilita si ya está seleccionado.
                const isSelected = micro.name === currentName; // Marca como seleccionado si coincide con el nutriente actual.
                optionsHtml += `<option value="${micro.name}"
                                data-unit="${micro.unit}"
                                data-type="${micro.type}"
                                ${isSelected ? 'selected' : ''}
                                ${isDisabled && !isSelected ? 'disabled' : ''}>${micro.name}</option>`;
            });

            // Obtiene y ordena las unidades únicas de los micronutrientes disponibles para el selector de unidad.
            const unitOptions = Array.from(new Set(availableMicronutrients.map(m => m.unit))).sort();
            let unitSelectHtml = '';
            unitOptions.forEach(unit => {
                const isSelectedUnit = unit === currentUnit;
                unitSelectHtml += `<option value="${unit}" ${isSelectedUnit ? 'selected' : ''}>${unit}</option>`;
            });

            // Inserta el HTML de la fila en la tabla.
            row.innerHTML = `
                <td>
                    <select class="micronutrient-name-select" onchange="updateMicronutrientData(this)">
                        ${optionsHtml}
                    </select>
                </td>
                <td>
                    <input type="number" step="0.01" min="0" placeholder="Cantidad" value="${currentValue}">
                    <select class="micronutrient-unit-select">
                        ${unitSelectHtml}
                    </select>
                    <input type="hidden" class="micronutrient-type" value="${currentType}">
                </td>
                <td><button type="button" class="remove-btn" onclick="removeMicronutrientField(this, this.closest('tr').querySelector('.micronutrient-name-select').value)">&times;</button></td>
            `;
            editMicronutrientTableBody.appendChild(row);

            // Si se precargó un nutriente, asegura que la unidad y el tipo se actualicen correctamente.
            if (currentName) {
                const selectElement = row.querySelector('.micronutrient-name-select');
                if (selectElement) {
                    const selectedMicro = availableMicronutrients.find(m => m.name === currentName);
                    if (selectedMicro) {
                        row.querySelector('.micronutrient-unit-select').value = selectedMicro.unit;
                        row.querySelector('.micronutrient-type').value = selectedMicro.type;
                    }
                }
            }
            updateAddButtonState(); // Actualiza el estado del botón "Añadir Vitamina/Mineral".
            updateDropdownOptions(); // Actualiza las opciones de todos los selectores de micronutrientes.
        }

        /**
         * Elimina una fila de campo de micronutriente del modal de edición.
         * @param {HTMLElement} button - El botón que activó la eliminación.
         * @param {string} removedName - El nombre del micronutriente que se ha eliminado (para re-habilitar en otros selectores).
         */
        function removeMicronutrientField(button, removedName) {
            button.closest('tr').remove(); // Elimina la fila completa.
            updateAddButtonState(); // Actualiza el estado del botón "Añadir".
            updateDropdownOptions(); // Vuelve a habilitar la opción en otros selectores.
        }

        /**
         * Actualiza la unidad y el tipo del micronutriente cuando se cambia la selección en el dropdown de nombres.
         * @param {HTMLSelectElement} selectElement - El elemento <select> cuyo valor ha cambiado.
         */
        function updateMicronutrientData(selectElement) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const unitSelect = selectElement.closest('tr').querySelector('.micronutrient-unit-select');
            const typeHiddenInput = selectElement.closest('tr').querySelector('.micronutrient-type');

            if (selectedOption && selectedOption.value) {
                const unit = selectedOption.dataset.unit;
                const type = selectedOption.dataset.type;
                
                unitSelect.value = unit;
                typeHiddenInput.value = type;
            } else {
                // Si no se selecciona nada (opción vacía), limpia unidad y tipo.
                unitSelect.value = '';
                typeHiddenInput.value = '';
            }
            updateAddButtonState(); // Actualiza el estado del botón "Añadir".
            updateDropdownOptions(); // Re-evalúa las opciones habilitadas/deshabilitadas.
        }

        /**
         * Actualiza las opciones de todos los selectores de micronutrientes en el modal de edición.
         * Deshabilita los micronutrientes que ya han sido seleccionados en otra fila para evitar duplicados.
         */
        function updateDropdownOptions() {
            const allSelects = editMicronutrientTableBody.querySelectorAll('.micronutrient-name-select');
            
            // Primero, re-habilita todas las opciones en todos los selectores.
            allSelects.forEach(select => {
                Array.from(select.options).forEach(option => {
                    option.disabled = false;
                });
            });

            // Recopila los nombres de los micronutrientes actualmente seleccionados en CUALQUIER selector.
            const currentlySelectedNames = new Set();
            allSelects.forEach(select => {
                if (select.value) {
                    currentlySelectedNames.add(select.value);
                }
            });

            // Itera de nuevo sobre todos los selectores para deshabilitar las opciones ya seleccionadas.
            allSelects.forEach(select => {
                const currentSelectionInThisDropdown = select.value; // El nutriente seleccionado en ESTE dropdown.
                Array.from(select.options).forEach(option => {
                    // Si la opción no es la que está seleccionada actualmente en este dropdown,
                    // y el nombre de la opción ya está en el conjunto de nombres seleccionados globalmente, la deshabilita.
                    if (option.value && option.value !== currentSelectionInThisDropdown && currentlySelectedNames.has(option.value)) {
                        option.disabled = true;
                    }
                });
            });
        }

        /**
         * Actualiza el estado (habilitado/deshabilitado y texto) del botón "Añadir Vitamina/Mineral".
         * Se deshabilita si todos los micronutrientes disponibles ya han sido añadidos.
         */
        function updateAddButtonState() {
            const addButton = document.querySelector('.add-micronutrient-btn');
            
            // Obtiene los nombres de los micronutrientes ya seleccionados en el formulario.
            const selectedMicronutrientNames = new Set(
                Array.from(editMicronutrientTableBody.querySelectorAll('.micronutrient-name-select'))
                    .map(select => select.value)
                    .filter(name => name !== '')
            );
            // Calcula cuántos micronutrientes aún no han sido seleccionados.
            const remainingUnselectedCount = availableMicronutrients.length - selectedMicronutrientNames.size;

            if (remainingUnselectedCount <= 0) {
                addButton.disabled = true;
                addButton.textContent = 'Todas las Vitaminas/Minerales añadidas';
            } else {
                addButton.disabled = false;
                addButton.textContent = '+ Añadir Vitamina/Mineral';
            }
        }

        // Listener para el envío del formulario de edición/creación de alimento.
        document.getElementById('editFoodForm').addEventListener('submit', function(event) {
            event.preventDefault(); // Previene el envío por defecto del formulario.

            // Realiza la validación de macronutrientes y campos obligatorios.
            if (!validateMacronutrients() || !validateFormFields()) {
                showToast('Por favor, corrige los errores en el formulario.');
                return; // Detiene el envío si hay errores de validación.
            }

            const index = parseInt(document.getElementById('editFoodIndex').value);
            const isNewFood = index === -1;
            let food;

            if (isNewFood) {
                // Si es un nuevo alimento, crea un objeto vacío con propiedades iniciales.
                food = { micronutrients: {}, characteristics: [] };
                foodData.push(food); // Añade el nuevo alimento al array de datos.
                currentEditingFoodIndex = foodData.length - 1; // Actualiza el índice al del nuevo alimento.
            } else {
                food = foodData[index]; // Si es un alimento existente, toma el objeto actual.
            }
            
            // Asigna los valores de los campos del formulario al objeto 'food'.
            food.name = document.getElementById('editName').value.trim();
            food.unitBase = editUnitBaseSelect.value;
            food.price = parseFloat(editPriceInput.value);
            food.category = document.getElementById('editCategory').value;

            // Recopila las características especiales seleccionadas.
            const selectedCharacteristics = [];
            document.querySelectorAll('#editCharacteristics input[type="checkbox"]:checked').forEach(checkbox => {
                selectedCharacteristics.push(checkbox.value);
            });
            food.characteristics = selectedCharacteristics;

            // Asigna los valores de los macronutrientes.
            food.protein = parseFloat(document.getElementById('editProtein').value);
            food.carbs = parseFloat(document.getElementById('editCarbs').value);
            food.sugars = parseFloat(document.getElementById('editSugars').value);
            food.fat = parseFloat(document.getElementById('editFat').value);
            food.saturatedFat = parseFloat(document.getElementById('editSaturatedFat').value);
            food.fiber = parseFloat(document.getElementById('editFiber').value);
            food.salt = parseFloat(document.getElementById('editSalt').value);
            food.calories = parseFloat(calculateCalories()); // Recalcula las calorías finales.

            // Recopila los micronutrientes dinámicos.
            food.micronutrients = {}; // Reinicia el objeto de micronutrientes.
            const micronutrientRows = editMicronutrientTableBody.querySelectorAll('.micronutrient-input-row');
            micronutrientRows.forEach(row => {
                const nameSelect = row.querySelector('.micronutrient-name-select');
                const valueInput = row.querySelector('input[type="number"]');
                const unitSelect = row.querySelector('.micronutrient-unit-select');
                const typeHiddenInput = row.querySelector('.micronutrient-type');
                
                const name = nameSelect.value.trim();
                const value = parseFloat(valueInput.value);
                const unit = unitSelect.value.trim();
                const type = typeHiddenInput.value.trim();

                // Solo añade el micronutriente si todos sus campos son válidos y están presentes.
                if (name && !isNaN(value) && value >= 0 && unit && type) {
                    food.micronutrients[name] = {
                        value: value,
                        unit: unit,
                        type: type
                    };
                }
            });

            filterAndSortFoods(); // Vuelve a filtrar y ordenar para actualizar la lista mostrada.
            closeModal('foodEditModal'); // Cierra el modal de edición.
            showToast(isNewFood ? '¡Alimento añadido con éxito!' : '¡Alimento actualizado con éxito!');
        });

        /**
         * Valida todos los campos del formulario de edición de alimentos.
         * - Comprueba que los campos requeridos no estén vacíos.
         * - Comprueba que los campos numéricos sean números válidos y no negativos.
         * Muestra mensajes de error específicos para cada campo inválido.
         * @returns {boolean} - True si todos los campos son válidos, false en caso contrario.
         */
        function validateFormFields() {
            let isValid = true;
            const form = document.getElementById('editFoodForm');
            // Selecciona todos los inputs y selects marcados como 'required'.
            const requiredInputs = form.querySelectorAll('input[required], select[required]');

            requiredInputs.forEach(input => {
                const value = input.value.trim();
                const messageSpan = input.nextElementSibling; // Asume que el span de validación es el siguiente hermano.

                if (!value) {
                    input.classList.add('invalid');
                    messageSpan.textContent = 'Este campo es obligatorio.';
                    messageSpan.style.display = 'block';
                    isValid = false;
                } else if (input.type === 'number' && (isNaN(parseFloat(value)) || parseFloat(value) < 0)) {
                    input.classList.add('invalid');
                    messageSpan.textContent = 'Debe ser un número positivo.';
                    messageSpan.style.display = 'block';
                    isValid = false;
                } else {
                    input.classList.remove('invalid');
                    messageSpan.style.display = 'none';
                }
            });

            // Valida los campos de micronutrientes dinámicos.
            const micronutrientRows = editMicronutrientTableBody.querySelectorAll('.micronutrient-input-row');
            micronutrientRows.forEach(row => {
                const nameSelect = row.querySelector('.micronutrient-name-select');
                const valueInput = row.querySelector('input[type="number"]');

                // Si se ha seleccionado un nombre de micronutriente, valida la cantidad.
                if (nameSelect.value) {
                    const val = parseFloat(valueInput.value);
                    if (isNaN(val) || val < 0) {
                        valueInput.classList.add('invalid');
                        let msgSpan = valueInput.nextElementSibling;
                        if (!msgSpan || !msgSpan.classList.contains('validation-message')) {
                            msgSpan = document.createElement('span');
                            msgSpan.classList.add('validation-message');
                            valueInput.parentNode.insertBefore(msgSpan, valueInput.nextSibling);
                        }
                        msgSpan.textContent = 'La cantidad debe ser un número positivo.';
                        msgSpan.style.display = 'block';
                        isValid = false;
                    } else {
                        valueInput.classList.remove('invalid');
                        const msgSpan = valueInput.nextElementSibling;
                        if (msgSpan && msgSpan.classList.contains('validation-message')) {
                            msgSpan.style.display = 'none';
                        }
                    }
                } else {
                    // Si no se ha seleccionado un micronutriente pero hay un valor en el input (ej. el usuario borró la selección)
                    valueInput.classList.remove('invalid'); // Asegura que no quede marcado como inválido si el nombre está vacío.
                    const msgSpan = valueInput.nextElementSibling;
                    if (msgSpan && msgSpan.classList.contains('validation-message')) {
                        msgSpan.style.display = 'none';
                    }
                }
            });

            return isValid;
        }

        /**
         * Muestra un modal de confirmación antes de eliminar un alimento.
         * Cierra los modales de detalle y edición antes de abrir el de confirmación.
         */
        function confirmDeleteFood() {
            closeModal('foodDetailModal'); // Cierra el modal de detalle si está abierto.
            closeModal('foodEditModal'); // Cierra el modal de edición si está abierto.

            const foodName = foodData[currentEditingFoodIndex].name;
            confirmationMessage.innerHTML = `¿Estás seguro de que quieres **eliminar** el alimento: **${foodName}**? Esta acción no se puede deshacer.`;
            confirmActionButton.onclick = deleteFood; // Asigna la función de eliminación al botón de confirmar.
            confirmActionButton.className = 'btn btn-danger'; // Asegura que el botón sea de peligro (rojo).
            openModal('confirmationModal');
        }

        /**
         * Elimina el alimento actualmente seleccionado de `foodData` y actualiza la interfaz.
         * Se llama desde el modal de confirmación.
         */
        function deleteFood() {
            foodData.splice(currentEditingFoodIndex, 1); // Elimina el alimento del array.
            closeModal('confirmationModal'); // Cierra el modal de confirmación.
            filterAndSortFoods(); // Vuelve a renderizar la lista para reflejar la eliminación.
            showToast('¡Alimento eliminado con éxito!');
        }

        /**
         * Alterna la visibilidad del selector de micronutrientes específico en la sección de ordenación.
         * Esto se activa cuando se selecciona "Vitaminas", "Minerales" u "Otros" como criterio de ordenación.
         */
        function toggleMicronutrientSortSelect() {
            const sortCriteria = sortCriteriaSelect.value;
            if (sortCriteria === 'vitamins' || sortCriteria === 'minerals' || sortCriteria === 'others') {
                micronutrientSortContainer.style.display = 'flex'; // Muestra el contenedor.
                populateMicronutrientSortSelect(sortCriteria); // Rellena el selector de micronutrientes.
            } else {
                micronutrientSortContainer.style.display = 'none'; // Oculta el contenedor.
            }
        }

        /**
         * Rellena el selector de micronutrientes para la ordenación con los nutrientes del tipo especificado.
         * @param {string} type - El tipo de micronutriente a poblar ("vitamins", "minerals", "others").
         */
        function populateMicronutrientSortSelect(type) {
            sortMicronutrientSelect.innerHTML = '<option value="">Selecciona un nutriente</option>';
            const uniqueMicrosOfType = new Set();
            foodData.forEach(food => {
                for (const [name, data] of Object.entries(food.micronutrients)) {
                    const dataTypeNormalized = data.type.toLowerCase();
                    const sortTypeNormalized = type.toLowerCase();

                    // Comprueba si el tipo de micronutriente coincide con el criterio de ordenación.
                    if ((sortTypeNormalized === 'vitamins' && dataTypeNormalized === 'vitamina') ||
                        (sortTypeNormalized === 'minerals' && dataTypeNormalized === 'mineral') ||
                        (sortTypeNormalized === 'others' && dataTypeNormalized !== 'vitamina' && dataTypeNormalized !== 'mineral')) {
                        uniqueMicrosOfType.add(name);
                    }
                }
            });

            const sortedMicros = Array.from(uniqueMicrosOfType).sort(); // Ordena los micronutrientes encontrados.
            sortedMicros.forEach(microName => {
                const option = document.createElement('option');
                option.value = microName;
                option.textContent = microName;
                sortMicronutrientSelect.appendChild(option);
            });
            // Restablece la selección si el micronutriente anteriormente seleccionado ya no está disponible para el nuevo tipo.
            if (!sortedMicros.includes(sortMicronutrientSelect.value)) {
                sortMicronutrientSelect.value = "";
            }
        }

        /**
         * Alterna la visibilidad de la sección de filtros avanzados.
         */
        function toggleAdvancedFilters() {
            advancedFilterContainer.classList.toggle('expanded'); // Alterna la clase 'expanded'.
            const toggleBtn = document.querySelector('.filter-toggle-btn');
            // Cambia el texto del botón según el estado del panel.
            if (advancedFilterContainer.classList.contains('expanded')) {
                toggleBtn.textContent = 'Ocultar Filtros Avanzados';
            } else {
                toggleBtn.textContent = 'Mostrar Filtros Avanzados';
            }
        }

        /**
         * Restablece todos los campos de los filtros avanzados a sus valores por defecto.
         * Luego, vuelve a aplicar los filtros y la ordenación para actualizar la lista de alimentos.
         */
        function resetAdvancedFilters() {
            // Limpia los valores de los inputs numéricos.
            filterCaloriesMin.value = '';
            filterCaloriesMax.value = '';
            filterProteinMin.value = '';
            filterFatMax.value = '';
            filterCarbsMin.value = '';
            filterFiberMin.value = '';
            filterSugarMax.value = '';
            filterSaltMax.value = '';
            filterPriceMax.value = '';
            filterCategorySelect.value = ''; // Restablece la categoría a "Todas".

            // Desmarca todos los checkboxes de características especiales.
            document.querySelectorAll('#filterSpecialCharacteristics input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });

            filterAndSortFoods(); // Vuelve a renderizar la lista con los filtros restablecidos.
            showToast('Filtros avanzados restablecidos.');
        }

        /**
         * Aplica los filtros (búsqueda y avanzados) y la ordenación a la lista de alimentos.
         * Luego, renderiza las tarjetas de alimentos con los resultados.
         */
        function filterAndSortFoods() {
            let displayedFoods = [...foodData]; // Crea una copia para no modificar el array original.

            const searchTerm = searchInput.value.toLowerCase();
            const sortByCriteria = sortCriteriaSelect.value;
            const sortDirection = sortDirectionSelect.value;
            const sortMicronutrient = sortMicronutrientSelect.value;

            // Paso 1: Aplicar Filtro de Búsqueda
            if (searchTerm) {
                displayedFoods = displayedFoods.filter(food =>
                    food.name.toLowerCase().includes(searchTerm)
                );
            }

            // Paso 2: Aplicar Filtros Avanzados
            const filterCalMin = parseFloat(filterCaloriesMin.value);
            const filterCalMax = parseFloat(filterCaloriesMax.value);
            const filterProtMin = parseFloat(filterProteinMin.value);
            const filterFatMx = parseFloat(filterFatMax.value);
            const filterCarbsMinVal = parseFloat(filterCarbsMin.value);
            const filterFiberMinVal = parseFloat(filterFiberMin.value);
            const filterSugarMx = parseFloat(filterSugarMax.value);
            const filterSaltMx = parseFloat(filterSaltMax.value);
            const filterPriceMx = parseFloat(filterPriceMax.value);
            const filterCat = filterCategorySelect.value;
            // Obtiene las características especiales seleccionadas en los filtros.
            const selectedCharacteristics = Array.from(document.querySelectorAll('#filterSpecialCharacteristics input[type="checkbox"]:checked')).map(cb => cb.value);

            displayedFoods = displayedFoods.filter(food => {
                // Filtros de macronutrientes (rango o máximo/mínimo)
                if (!isNaN(filterCalMin) && food.calories < filterCalMin) return false;
                if (!isNaN(filterCalMax) && food.calories > filterCalMax) return false;
                if (!isNaN(filterProtMin) && food.protein < filterProtMin) return false;
                if (!isNaN(filterFatMx) && food.fat > filterFatMx) return false;
                if (!isNaN(filterCarbsMinVal) && food.carbs < filterCarbsMinVal) return false;
                if (!isNaN(filterFiberMinVal) && food.fiber < filterFiberMinVal) return false;
                if (!isNaN(filterSugarMx) && food.sugars > filterSugarMx) return false;
                if (!isNaN(filterSaltMx) && food.salt > filterSaltMx) return false;

                // Filtro de precio (siempre por kg/L)
                const foodPricePerKgOrL = food.price; // El precio ya está almacenado por kg/L.
                if (!isNaN(filterPriceMx) && foodPricePerKgOrL > filterPriceMx) return false;

                // Filtro de categoría
                if (filterCat && food.category !== filterCat) return false;

                // Filtro de características: asegura que el alimento tenga TODAS las características seleccionadas.
                if (selectedCharacteristics.length > 0) {
                    const hasAllCharacteristics = selectedCharacteristics.every(char =>
                        food.characteristics && food.characteristics.includes(char)
                    );
                    if (!hasAllCharacteristics) return false;
                }

                return true; // Si el alimento pasa todos los filtros, lo incluye.
            });

            // Paso 3: Aplicar Ordenación
            displayedFoods.sort((a, b) => {
                let valA, valB;
                let comparison = 0;

                switch (sortByCriteria) {
                    case 'name':
                        comparison = a.name.localeCompare(b.name);
                        break;
                    case 'calories':
                        valA = a.calories;
                        valB = b.calories;
                        comparison = valA - valB;
                        break;
                    case 'protein':
                        valA = a.protein;
                        valB = b.protein;
                        comparison = valA - valB;
                        break;
                    case 'fat':
                        valA = a.fat;
                        valB = b.fat;
                        comparison = valA - valB;
                        break;
                    case 'carbs':
                        valA = a.carbs;
                        valB = b.carbs;
                        comparison = valA - valB;
                        break;
                    case 'fiber':
                        valA = a.fiber;
                        valB = b.fiber;
                        comparison = valA - valB;
                        break;
                    case 'vitamins':
                    case 'minerals':
                    case 'others':
                        // Ordenación por micronutriente específico si está seleccionado.
                        if (sortMicronutrient) {
                            valA = a.micronutrients[sortMicronutrient] ? a.micronutrients[sortMicronutrient].value : 0;
                            valB = b.micronutrients[sortMicronutrient] ? b.micronutrients[sortMicronutrient].value : 0;
                            comparison = valA - valB;
                        } else {
                            comparison = 0; // No hay micronutriente específico, no hay ordenación por este criterio.
                        }
                        break;
                    default:
                        comparison = 0;
                }

                // Aplica la dirección de ordenación (ascendente o descendente).
                return sortDirection === 'asc' ? comparison : -comparison;
            });

            // L_E_O: Reinicia el contador de alimentos mostrados cuando los filtros cambian,
            // para que la paginación funcione correctamente con los nuevos resultados filtrados/ordenados.
            displayedFoodCount = ITEMS_PER_LOAD;
            renderFoodCards(displayedFoods); // Renderiza la lista actualizada.
        }

        /**
         * Exporta los datos de los alimentos a un archivo JSON descargable.
         * Antes de exportar, asegura que las calorías estén calculadas.
         */
        function exportData() {
            // Recalcula las calorías para asegurar que estén actualizadas antes de exportar.
            foodData.forEach(food => {
                const protein = food.protein || 0;
                const carbs = food.carbs || 0;
                const fat = food.fat || 0;
                food.calories = parseFloat(((protein * 4) + (carbs * 4) + (fat * 9)).toFixed(1));
            });

            const dataStr = JSON.stringify(foodData, null, 2); // Convierte los datos a una cadena JSON formateada.
            const blob = new Blob([dataStr], { type: 'application/json' }); // Crea un Blob con los datos.
            const url = URL.createObjectURL(blob); // Crea una URL para el Blob.
            const a = document.createElement('a'); // Crea un elemento <a> para la descarga.
            a.href = url;
            a.download = 'alimentos.json'; // Nombre del archivo.
            document.body.appendChild(a);
            a.click(); // Simula un clic para iniciar la descarga.
            document.body.removeChild(a); // Limpia el elemento <a>.
            URL.revokeObjectURL(url); // Libera la URL del Blob.
            showToast('¡Datos exportados con éxito!');
        }

        /**
         * Importa datos de alimentos desde un archivo JSON seleccionado por el usuario.
         * Realiza una validación básica del formato del JSON importado.
         * @param {Event} event - El evento de cambio del input de archivo.
         */
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result); // Parsea el contenido JSON.
                    // L_E_O: Validación más estricta para la importación:
                    // Verifica que sea un array y que cada elemento tenga las propiedades esenciales.
                    if (Array.isArray(imported) && imported.every(item =>
                        item.name && typeof item.protein === 'number' && typeof item.carbs === 'number' &&
                        typeof item.fat === 'number' && item.hasOwnProperty('unitBase') &&
                        item.hasOwnProperty('price') && Array.isArray(item.characteristics) && item.category &&
                        typeof item.micronutrients === 'object'
                    )) {
                        foodData = imported; // Reemplaza los datos existentes con los importados.
                        // Recalcula las calorías para los alimentos importados (por si no estaban).
                        foodData.forEach(food => {
                            const protein = food.protein || 0;
                            const carbs = food.carbs || 0;
                            const fat = food.fat || 0;
                            food.calories = parseFloat(((protein * 4) + (carbs * 4) + (fat * 9)).toFixed(1));
                        });
                        filterAndSortFoods(); // Actualiza la interfaz con los nuevos datos.
                        showToast('¡Datos importados con éxito!');
                    } else {
                        showToast('Error: El archivo JSON no tiene el formato esperado. Asegúrate de que contiene un array de alimentos con todas las propiedades requeridas (nombre, macronutrientes, unitBase, price, category, characteristics, micronutrients).');
                        console.error('Error: Invalid JSON format for import.', imported);
                    }
                } catch (error) {
                    showToast('Error al parsear el archivo JSON. Asegúrate de que es un JSON válido.');
                    console.error('Error importing JSON:', error);
                }
            };
            reader.readAsText(file); // Lee el archivo como texto.
        }

        /**
         * Función para cargar datos desde un archivo JSON local (en la misma carpeta).
         * Asume que el archivo se llama `alimentos.json`.
         */
        async function loadFoodDataFromFile() {
            try {
                // L_E_O: Intenta obtener el archivo JSON.
                const response = await fetch('alimentos.json'); 
                if (!response.ok) {
                    // Si el archivo no se encuentra o hay un error HTTP, lanza un error.
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json(); // Parsea la respuesta como JSON.
                // Valida el formato de los datos cargados.
                if (Array.isArray(data) && data.every(item =>
                    item.name && typeof item.protein === 'number' && typeof item.carbs === 'number' &&
                    typeof item.fat === 'number' && item.hasOwnProperty('unitBase') &&
                    item.hasOwnProperty('price') && Array.isArray(item.characteristics) && item.category &&
                    typeof item.micronutrients === 'object'
                )) {
                    foodData = data; // Asigna los datos cargados a `foodData`.
                    // Recalcula las calorías para asegurar que estén correctas después de la carga.
                    foodData.forEach(food => {
                        const protein = food.protein || 0;
                        const carbs = food.carbs || 0;
                        const fat = food.fat || 0;
                        food.calories = parseFloat(((protein * 4) + (carbs * 4) + (fat * 9)).toFixed(1));
                    });
                    showToast('¡Datos cargados desde alimentos.json con éxito!');
                } else {
                    console.error('Error: El archivo alimentos.json no tiene el formato esperado.');
                    showToast('Error: Formato de datos incorrecto en alimentos.json.');
                }
            } catch (error) {
                console.error('Error al cargar alimentos.json:', error);
                showToast('Error al cargar alimentos.json. Asegúrate de que el archivo existe y es válido.');
            } finally {
                // Siempre inicializa la UI después de intentar cargar los datos.
                populateFilterCategories(); // Rellena las categorías.
                populateFilterSpecialCharacteristics(); // Rellena las características especiales.
                toggleMicronutrientSortSelect(); // Inicializa el selector de micronutrientes para la ordenación.
                filterAndSortFoods(); // Realiza el renderizado inicial y aplica cualquier filtro/ordenación por defecto.
            }
        }

        /**
         * Rellena los selectores de categorías de alimentos en los filtros y en el modal de edición.
         */
        function populateFilterCategories() {
            // Rellena el selector de categorías en los filtros.
            filterCategorySelect.innerHTML = '<option value="">Todas</option>';
            foodCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                filterCategorySelect.appendChild(option);
            });
            // También rellena el selector de categorías en el modal de edición/añadir.
            const editCategorySelect = document.getElementById('editCategory');
            editCategorySelect.innerHTML = '<option value="">Selecciona una categoría</option>';
            foodCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                editCategorySelect.appendChild(option);
            });
        }

        /**
         * Rellena los checkboxes de características especiales en la sección de filtros avanzados.
         */
        function populateFilterSpecialCharacteristics() {
            filterSpecialCharacteristicsDiv.innerHTML = ''; // Limpia los checkboxes existentes
            specialCharacteristics.forEach(char => {
                const id = `filterChar_${char.replace(/\s+/g, '')}`; // Crea un ID único para cada checkbox.
                filterSpecialCharacteristicsDiv.innerHTML += `
                    <label for="${id}">
                        <input type="checkbox" id="${id}" value="${char}" onchange="filterAndSortFoods()">
                        ${char}
                    </label>
                `;
            });
        }

        // L_E_O: Configuración inicial al cargar el DOM.
        document.addEventListener('DOMContentLoaded', () => {
            loadFoodDataFromFile(); // L_E_O: Llama a la nueva función para cargar datos desde el archivo JSON.
        });
    </script>
</body>
</html>
